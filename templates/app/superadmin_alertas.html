<!-- templates/app/superadmin_alertas.html -->
{% extends "base/base_app.html" %}

{% block title %}Alertas globales · Consola Superadmin · ORBION{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}

{# =========================
HELPERS (baseline-coherentes)
========================= #}
{% macro norm_str(v) -%}
{{ (v or "")|string|trim|lower }}
{%- endmacro %}

{% macro fmt_dt(v) -%}
  {# soporta datetime o string; si no, "—" #}
  {% if not v %}
    —
  {% else %}
    {% set s = v|string %}
    {# si viene como "2025-12-23 10:11:12" o ISO, mostramos "dd-mm-yyyy hh:mm" si posible #}
    {# como baseline minimalista: dd-mm-yyyy hh:mm solo si es datetime real con strftime #}
    {% if v.strftime is defined %}
{{ v.strftime("%d-%m-%Y %H:%M") }}
    {% else %}
      {# fallback: toma los primeros 16 chars (YYYY-MM-DD HH:MM) y no rompe #}
{{ s[:16] }}
    {% endif %}
  {% endif %}
{%- endmacro %}

{% macro badge_tipo(tipo) -%}
  {% set t = norm_str(tipo) %}
<span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[10px] md:text-[11px] font-medium
    {% if t == 'stock_min' %}
      bg-rose-500/10 text-rose-200 border-rose-500/40
    {% elif t == 'stock_max' %}
      bg-amber-500/10 text-amber-200 border-amber-500/40
    {% elif t == 'vencido' %}
      bg-rose-500/10 text-rose-200 border-rose-500/40
    {% elif t == 'proximo_vencer' %}
      bg-orange-500/10 text-orange-200 border-orange-500/40
    {% else %}
      bg-slate-700/40 text-slate-100 border-slate-600
    {% endif %}">
    {{ tipo or "—" }}
</span>
{%- endmacro %}

{% macro badge_estado(estado) -%}
  {% set e = norm_str(estado) %}
  {% if e == "pendiente" %}
<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] md:text-[11px] font-medium
                 bg-amber-500/10 text-amber-200 border border-amber-500/40">
    Pendiente
</span>
  {% elif e == "enviada" or e == "leida" %}
<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] md:text-[11px] font-medium
                 bg-emerald-500/10 text-emerald-200 border border-emerald-500/40">
    {{ (estado or "")|capitalize }}
</span>
  {% elif e == "error" %}
<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] md:text-[11px] font-medium
                 bg-rose-500/10 text-rose-200 border border-rose-500/40">
    Error
</span>
  {% else %}
<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] md:text-[11px] font-medium
                 bg-slate-700/40 text-slate-100 border border-slate-600">
    {{ (estado or "—")|capitalize }}
</span>
  {% endif %}
{%- endmacro %}

<div class="space-y-6 sm:space-y-8 max-w-5xl mx-auto">

    {# =========================
    HEADER ÚNICO (mobile-first)
    ========================= #}
    <header class="flex items-start sm:items-center justify-between gap-3">
        <div class="min-w-0 space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Consola superadmin
            </p>
            <h1 class="text-base sm:text-lg font-semibold text-slate-100 tracking-tight truncate">
                Alertas globales
            </h1>
            <p class="text-[11px] sm:text-xs text-slate-400 leading-snug max-w-xl">
                Alertas de stock, vencimientos y eventos críticos en todos los negocios de ORBION.
            </p>
        </div>

        <div class="shrink-0 flex items-center gap-2">
            <a href="/superadmin/dashboard"
               class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1
                text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300
                transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                ← Consola
            </a>
        </div>
    </header>

    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-4 sm:py-5 space-y-4">

        <header class="space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Panel global
            </p>
            <p class="text-[11px] text-slate-400 max-w-md">
                Monitorea el estado de las alertas generadas por reglas y procesos de cada negocio.
            </p>
        </header>

        {% if alertas and alertas|length > 0 %}

        {# =========================
        MOBILE: CARDS
        ========================= #}
        <div class="space-y-3 md:hidden pt-2">
            {% for a in alertas %}
            <article class="rounded-2xl border border-slate-800 bg-slate-900 px-3 py-3 space-y-2">
                <div class="flex items-start justify-between gap-2">
                    <div class="space-y-0.5 min-w-0">
                        <a href="/superadmin/negocios/{{ a.negocio_id }}"
                           class="text-[11px] text-slate-300 hover:text-cyan-300 transition-colors truncate block">
                            {{ a.negocio.nombre_fantasia if a.negocio else "Negocio #" ~ a.negocio_id }}
                        </a>
                        <p class="text-[10px] text-slate-500">
                            ID negocio: {{ a.negocio_id }}
                        </p>
                    </div>

                    <div class="flex flex-col items-end gap-1">
                        {{ badge_tipo(a.tipo) }}
                        {{ badge_estado(a.estado) }}
                    </div>
                </div>

                <div class="space-y-1">
                    <p class="text-[11px] text-slate-100">
                        {{ a.mensaje or "—" }}
                    </p>

                    <p class="text-[10px] text-slate-500">
                        Creación:
                        <span class="text-slate-300">{{ fmt_dt(a.fecha_creacion) }}</span>
                        {% if a.fecha_envio %}
                        · Envío:
                        <span class="text-slate-300">{{ fmt_dt(a.fecha_envio) }}</span>
                        {% endif %}
                    </p>

                    {% if a.origen %}
                    <p class="text-[10px] text-slate-500">
                        Origen: <span class="text-slate-300">{{ a.origen }}</span>
                    </p>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        {# =========================
        DESKTOP/TABLET: TABLA
        ========================= #}
        <div class="hidden md:block border border-slate-800 rounded-2xl overflow-x-auto bg-slate-900/80">
            <table class="min-w-full text-[11px] sm:text-xs text-left">
                <thead class="bg-slate-900/90">
                    <tr class="font-medium text-slate-400 uppercase tracking-wide">
                        <th class="px-4 py-2">Negocio</th>
                        <th class="px-4 py-2">Tipo</th>
                        <th class="px-4 py-2">Mensaje</th>
                        <th class="px-4 py-2">Estado</th>
                        <th class="px-4 py-2 whitespace-nowrap">Creación</th>
                        <th class="px-4 py-2 whitespace-nowrap">Envío</th>
                        <th class="px-4 py-2">Origen</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-slate-800/80">
                    {% for a in alertas %}
                    <tr class="hover:bg-slate-900 align-top">
                        <td class="px-4 py-2">
                            <div class="flex flex-col">
                                <a href="/superadmin/negocios/{{ a.negocio_id }}"
                                   class="font-medium text-slate-100 hover:text-cyan-300 transition-colors">
                                    {{ a.negocio.nombre_fantasia if a.negocio else "Negocio #" ~ a.negocio_id }}
                                </a>
                                <span class="text-[11px] text-slate-500">ID {{ a.negocio_id }}</span>
                            </div>
                        </td>

                        <td class="px-4 py-2">
                            {{ badge_tipo(a.tipo) }}
                        </td>

                        <td class="px-4 py-2 text-slate-100">
                            {{ a.mensaje or "—" }}
                        </td>

                        <td class="px-4 py-2">
                            {{ badge_estado(a.estado) }}
                        </td>

                        <td class="px-4 py-2 text-[11px] text-slate-400 whitespace-nowrap">
                            {{ fmt_dt(a.fecha_creacion) }}
                        </td>

                        <td class="px-4 py-2 text-[11px] text-slate-400 whitespace-nowrap">
                            {{ fmt_dt(a.fecha_envio) }}
                        </td>

                        <td class="px-4 py-2 text-[11px] text-slate-300">
                            {{ a.origen or "—" }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% else %}
        <div class="rounded-xl border border-slate-800 bg-slate-900 px-4 py-3 text-xs sm:text-sm text-slate-300">
            No se han generado alertas aún.
        </div>
        {% endif %}
    </section>

</div>
{% endblock %}
