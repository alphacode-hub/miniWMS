{# templates/app/superadmin_negocio_detalle.html #}
{% extends "base/base_app.html" %}

{% block title %}Negocio {{ negocio.nombre_fantasia }} · Consola Superadmin · ORBION{% endblock %}

{# En este template NO usamos page_header; el baseline actual es header único dentro de content #}
{% block page_header %}{% endblock %}

{% block content %}
{# Normaliza estado para Enum o string #}
{% set estado_val = (negocio.estado.value if negocio.estado is not none and negocio.estado.value is defined else negocio.estado) %}
{% set estado_val = (estado_val or "")|string|lower %}

{# Normaliza segmento (para chips + select) #}
{% set seg_val = (segmento or "emprendedor")|string|lower %}

<div class="space-y-6 sm:space-y-8 max-w-5xl mx-auto">

    {# =========================
    HEADER (mobile-first, 1 solo) — alineado al baseline del dashboard
    ========================= #}
    <header class="flex items-start sm:items-center justify-between gap-3">
        <div class="min-w-0 space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Superadmin global
            </p>

            <h1 class="text-base sm:text-lg font-semibold text-slate-100 tracking-tight truncate">
                Negocio · {{ negocio.nombre_fantasia }}
            </h1>

            <p class="text-[11px] sm:text-xs text-slate-400 leading-snug max-w-xl">
                Estado del negocio + segmento + suscripciones por módulo (SaaS modular).
            </p>

            {# Chips: contexto #}
            <div class="flex flex-wrap gap-2 pt-1">
                <span class="inline-flex items-center rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1
              text-[10px] sm:text-[11px] font-medium text-slate-300">
                    <span class="text-slate-500 mr-1">ID</span>
                    <span class="text-slate-100">{{ negocio.id }}</span>
                </span>

                <span class="inline-flex items-center rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1
              text-[10px] sm:text-[11px] font-medium text-slate-300">
                    
                    <span class="text-slate-100">{{ (seg_val or "emprendedor")|capitalize }}</span>
                </span>

                {% if estado_val == "activo" %}
                <span class="inline-flex items-center rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1
              text-[10px] sm:text-[11px] font-medium text-emerald-200">
                    Estado: Activo
                </span>
                {% else %}
                <span class="inline-flex items-center rounded-full border border-rose-500/40 bg-rose-500/10 px-3 py-1
              text-[10px] sm:text-[11px] font-medium text-rose-200">
                    Estado: {{ (estado_val or "desconocido")|capitalize }}
                </span>
                {% endif %}

                <span class="inline-flex items-center rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1
              text-[10px] sm:text-[11px] font-medium text-slate-300">
                    <span class="text-slate-500 mr-1">Módulos</span>
                    <span class="text-slate-100">{{ modulos_activos or 0 }}</span>
                </span>

                {% if next_period_end %}
                <span class="inline-flex items-center rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1
              text-[10px] sm:text-[11px] font-medium text-slate-300">
                    <span class="text-slate-500 mr-1">Próximo corte</span>
                    <span class="text-slate-100">{{ next_period_end[:10] }}</span>
                </span>
                {% endif %}
            </div>
        </div>

        <div class="shrink-0 pt-0.5">
            <a href="/superadmin/negocios"
               class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1
            text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300
            transition-colors">
                ← Volver a negocios
            </a>
        </div>
    </header>

    {# =========================
    PANEL NEGOCIO
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-5 sm:py-6 space-y-5">

        <header class="space-y-2">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Negocio
            </p>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="space-y-1 min-w-0">
                    <h2 class="text-sm sm:text-base font-semibold text-slate-100 truncate">
                        {{ negocio.nombre_fantasia }}
                    </h2>
                    <p class="text-[11px] text-slate-400">
                        ID {{ negocio.id }} · Usuarios {{ usuarios_count or 0 }} · Productos {{ productos_count or 0 }}
                    </p>
                </div>

                <div class="flex flex-wrap gap-2">
                    <a href="/superadmin/negocios/{{ negocio.id }}/ver-como"
                       class="inline-flex justify-center items-center px-4 h-10 rounded-full text-[11px] sm:text-xs font-semibold
            text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 transition-transform transition-colors active:scale-[0.97]">
                        Ver como este negocio
                    </a>

                </div>
            </div>
        </header>

        {# =========================
        FORM: Estado + Segmento (2-up en desktop, stacked en mobile)
        ========================= #}
        <div class="border-t border-slate-800 pt-4 space-y-4">

            {# ---- Segmento ---- #}
            <form action="/superadmin/negocios/{{ negocio.id }}/segmento"
                  method="post"
                  class="space-y-3">

                <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
                    <div class="sm:col-span-8 space-y-1.5">
                        <label for="segmento" class="text-[11px] font-semibold text-slate-200">
                            Segmento del negocio
                        </label>

                        <select id="segmento"
                                name="segmento"
                                class="w-full h-10 rounded-xl border border-slate-700 bg-slate-900 px-3 text-sm text-slate-100
                   focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400">
                            <option value="emprendedor" {% if seg_val=="emprendedor" %}selected{% endif %}>Emprendedor</option>
                            <option value="pyme" {% if seg_val=="pyme" %}selected{% endif %}>Pyme</option>
                            <option value="enterprise" {% if seg_val=="enterprise" %}selected{% endif %}>Enterprise</option>
                        </select>
                    </div>

                    <div class="sm:col-span-4">
                        <button type="submit"
                                class="w-full h-10 inline-flex justify-center items-center px-4 rounded-full text-[11px] sm:text-xs font-semibold
                   text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 shadow-sm active:scale-[0.97]
                   transition-transform transition-colors">
                            Guardar segmento
                        </button>
                    </div>
                </div>

                <p class="text-[11px] text-slate-400">
                    El segmento modifica el <span class="text-slate-200 font-medium">entitlements snapshot</span> (feature gates / límites)
                    y es la base para pricing y elegibilidad de módulos.
                </p>
            </form>

            {# ---- Estado ---- #}
            <form action="/superadmin/negocios/{{ negocio.id }}/estado"
                  method="post"
                  class="space-y-3">

                <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
                    <div class="sm:col-span-8 space-y-1.5">
                        <label for="estado" class="text-[11px] font-semibold text-slate-200">
                            Estado del negocio
                        </label>

                        <select id="estado"
                                name="estado"
                                class="w-full h-10 rounded-xl border border-slate-700 bg-slate-900 px-3 text-sm text-slate-100
                   focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400">
                            <option value="activo" {% if estado_val=="activo" %}selected{% endif %}>Activo</option>
                            <option value="suspendido" {% if estado_val=="suspendido" %}selected{% endif %}>Suspendido</option>
                        </select>
                    </div>

                    <div class="sm:col-span-4">
                        <button type="submit"
                                class="w-full h-10 inline-flex justify-center items-center px-4 rounded-full text-[11px] sm:text-xs font-semibold
                   text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 shadow-sm active:scale-[0.97]
                   transition-transform transition-colors">
                            Guardar estado
                        </button>
                    </div>
                </div>

                <p class="text-[11px] text-slate-400">
                    Suspender bloquea acceso operativo. Las suscripciones por módulo se mantienen para auditoría.
                </p>
            </form>

        </div>
    </section>

    {# =========================
    SUSCRIPCIONES POR MÓDULO
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-5 sm:py-6 space-y-4">

        <header class="space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                SaaS modular
            </p>
            <h3 class="text-sm sm:text-base font-semibold text-slate-100">
                Suscripciones por módulo
            </h3>
            <p class="text-[11px] text-slate-400 max-w-2xl">
                Esta vista refleja la verdad del sistema: enabled/status/period/cancel_at_period_end por módulo.
            </p>
        </header>

        {% if modules and modules|length > 0 %}

        {# MOBILE: cards #}
        <div class="space-y-3 md:hidden">
            {% for m in modules %}
            <article class="rounded-2xl border border-slate-800 bg-slate-900 px-3 py-3 space-y-3">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <p class="text-[11px] font-semibold text-slate-100 truncate">{{ m.label }}</p>
                        <p class="text-[10px] text-slate-500">Slug: {{ m.slug }}</p>
                    </div>

                    <div class="flex flex-col items-end gap-1">
                        {% if m.enabled %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium
               bg-emerald-500/10 text-emerald-200 border border-emerald-500/40">
                            Enabled
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium
               bg-slate-800 text-slate-200 border border-slate-700">
                            Bloqueado
                        </span>
                        {% endif %}

                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium
               bg-cyan-500/10 text-cyan-200 border border-cyan-500/40">
                            {{ m.status or "unknown" }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 text-[11px] text-slate-300">
                    <div>
                        <p class="text-[10px] text-slate-500">Período hasta</p>
                        <p class="font-medium">{{ m.period_end[:10] if m.period_end else "—" }}</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500">Cancelación programada</p>
                        <p class="font-medium">{{ "Sí" if m.cancel_at_period_end else "No" }}</p>
                    </div>
                </div>

                {# Acciones (mobile-first): se muestran solo si el módulo está enabled o si está bloqueado para activar #}
                <div class="pt-1 flex flex-wrap gap-2">
                    {% if not m.enabled %}
                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/activate" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-semibold
                             text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 active:scale-[0.97] transition">
                            Activar (trial)
                        </button>
                    </form>
                    {% else %}
                    {% if m.cancel_at_period_end %}
                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/reactivate" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                               border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition">
                            Reactivar
                        </button>
                    </form>
                    {% else %}
                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/cancel" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                               border border-rose-500/40 text-rose-200 bg-rose-500/10 hover:bg-rose-500/15 transition">
                            Cancelar fin período
                        </button>
                    </form>
                    {% endif %}

                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/renew-now" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                             border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition">
                            Forzar renovación
                        </button>
                    </form>

                    {% if m.status != "suspended" %}
                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/suspend" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                               border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition">
                            Suspender
                        </button>
                    </form>
                    {% endif %}
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        {# DESKTOP/TABLET: table + acciones #}
        <div class="hidden md:block border border-slate-800 rounded-2xl overflow-x-auto bg-slate-900/80">
            <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900/90">
                    <tr class="font-medium text-slate-400 uppercase tracking-wide">
                        <th class="px-4 py-2 text-left">Módulo</th>
                        <th class="px-4 py-2 text-left">Slug</th>
                        <th class="px-4 py-2 text-left">Status</th>
                        <th class="px-4 py-2 text-left">Enabled</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap">Período hasta</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap">Cancelación programada</th>
                        <th class="px-4 py-2 text-left">Acciones</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-slate-800/80">
                    {% for m in modules %}
                    <tr class="hover:bg-slate-900 align-top">
                        <td class="px-4 py-2 text-slate-100 font-medium">{{ m.label }}</td>
                        <td class="px-4 py-2 text-slate-300">{{ m.slug }}</td>
                        <td class="px-4 py-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[11px] font-medium
                           bg-cyan-500/10 text-cyan-200 border-cyan-500/40">
                                {{ m.status or "unknown" }}
                            </span>
                        </td>
                        <td class="px-4 py-2">
                            {% if m.enabled %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[11px] font-medium
                           bg-emerald-500/10 text-emerald-200 border-emerald-500/40">
                                Sí
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full border text-[11px] font-medium
                           bg-slate-800 text-slate-200 border-slate-700">
                                No
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-2 text-slate-300 whitespace-nowrap">
                            {{ m.period_end[:10] if m.period_end else "—" }}
                        </td>
                        <td class="px-4 py-2 text-slate-300 whitespace-nowrap">
                            {{ "Sí" if m.cancel_at_period_end else "No" }}
                        </td>
                        <td class="px-4 py-2">
                            <div class="flex flex-wrap gap-2">
                                {% if not m.enabled %}
                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/activate" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-semibold
                                   text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 active:scale-[0.97] transition">
                                        Activar
                                    </button>
                                </form>
                                {% else %}
                                {% if m.cancel_at_period_end %}
                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/reactivate" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                     border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition">
                                        Reactivar
                                    </button>
                                </form>
                                {% else %}
                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/cancel" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                     border border-rose-500/40 text-rose-200 bg-rose-500/10 hover:bg-rose-500/15 transition">
                                        Cancelar
                                    </button>
                                </form>
                                {% endif %}

                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/renew-now" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                   border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition">
                                        Renovar ahora
                                    </button>
                                </form>

                                {% if m.status != "suspended" %}
                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/suspend" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                     border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition">
                                        Suspender
                                    </button>
                                </form>
                                {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% else %}
        <div class="rounded-xl border border-slate-800 bg-slate-900 px-4 py-3 text-xs sm:text-sm text-slate-300">
            No hay módulos registrados en entitlements para este negocio.
        </div>
        {% endif %}

    </section>

  

</div>
{% endblock %}
