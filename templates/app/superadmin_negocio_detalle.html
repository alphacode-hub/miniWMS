{# templates/app/superadmin_negocio_detalle.html #}
{% extends "base/base_app.html" %}

{% block title %}Negocio {{ negocio.nombre_fantasia }} · Consola Superadmin · ORBION{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}

{# =========================
HELPERS / NORMALIZACIÓN
========================= #}

{% macro norm_str(v) -%}
{{ (v or "")|string|trim|lower }}
{%- endmacro %}

{% macro fmt_date(v) -%}
  {# Acepta str (ISO) o datetime. Si no podemos, mostramos "—" #}
  {% if not v %}
    —
  {% else %}
    {% set s = v|string %}
    {# si viene tipo "2025-12-23 10:00:00+00:00" o ISO, con esto basta para UI #}
{{ s[:10] }}
  {% endif %}
{%- endmacro %}

{% macro chip(texto) -%}
<span class="inline-flex items-center rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1
               text-[10px] sm:text-[11px] font-medium text-slate-300">
    {{ texto }}
</span>
{%- endmacro %}

{% macro badge_estado(estado) -%}
  {% set s = norm_str(estado) %}
  {% if s == "activo" or s == "negocioestado.activo" or s == "active" %}
<span class="inline-flex items-center rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1
                 text-[10px] sm:text-[11px] font-medium text-emerald-200">
    Estado: Activo
</span>
  {% else %}
<span class="inline-flex items-center rounded-full border border-rose-500/40 bg-rose-500/10 px-3 py-1
                 text-[10px] sm:text-[11px] font-medium text-rose-200">
    Estado: {{ (estado or "desconocido")|string|capitalize }}
</span>
  {% endif %}
{%- endmacro %}

{% macro badge_enabled(enabled) -%}
  {% if enabled %}
<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] md:text-[11px] font-medium
                 bg-emerald-500/10 text-emerald-200 border border-emerald-500/40">
    Enabled
</span>
  {% else %}
<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] md:text-[11px] font-medium
                 bg-slate-800 text-slate-200 border border-slate-700">
    Bloqueado
</span>
  {% endif %}
{%- endmacro %}

{% macro badge_status(status) -%}
<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] md:text-[11px] font-medium
               bg-cyan-500/10 text-cyan-200 border border-cyan-500/40">
    {{ status or "unknown" }}
</span>
{%- endmacro %}

{% set estado_val = (negocio.estado.value if negocio.estado is not none and negocio.estado.value is defined else negocio.estado) %}
{% set estado_val = norm_str(estado_val) %}

{% set seg_val = norm_str(segmento or "emprendedor") %}

<div class="space-y-6 sm:space-y-8 max-w-5xl mx-auto">

    {# =========================
    HEADER (mobile-first, único)
    ========================= #}
    <header class="flex items-start sm:items-center justify-between gap-3">
        <div class="min-w-0 space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Superadmin global
            </p>

            <h1 class="text-base sm:text-lg font-semibold text-slate-100 tracking-tight truncate">
                Negocio · {{ negocio.nombre_fantasia }}
            </h1>

            <p class="text-[11px] sm:text-xs text-slate-400 leading-snug max-w-xl">
                Estado del negocio + segmento + suscripciones por módulo (SaaS modular).
            </p>

            <div class="flex flex-wrap gap-2 pt-1">
                {{ chip("ID " ~ negocio.id) }}
                {{ chip((seg_val or "emprendedor")|capitalize) }}
                {{ badge_estado(estado_val) }}
                {{ chip("Módulos " ~ (modulos_activos or 0)) }}
                {% if next_period_end %}
                {{ chip("Próximo corte " ~ fmt_date(next_period_end)) }}
                {% endif %}
            </div>
        </div>

        <div class="shrink-0 pt-0.5 flex items-center gap-2">
            <a href="/superadmin/negocios"
               class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1
                text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300
                transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                ← Volver
            </a>
            <a href="/superadmin/jobs"
               class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1
                text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300
                transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                Jobs
            </a>
        </div>
    </header>

    {# =========================
    PANEL NEGOCIO
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-5 sm:py-6 space-y-5">

        <header class="space-y-2">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Negocio
            </p>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="space-y-1 min-w-0">
                    <h2 class="text-sm sm:text-base font-semibold text-slate-100 truncate">
                        {{ negocio.nombre_fantasia }}
                    </h2>
                    <p class="text-[11px] text-slate-400">
                        ID {{ negocio.id }} · Usuarios {{ usuarios_count or 0 }} · Productos {{ productos_count or 0 }}
                    </p>
                </div>

                <div class="flex flex-wrap gap-2">
                    <a href="/superadmin/negocios/{{ negocio.id }}/auditoria"
                       class="inline-flex justify-center items-center px-4 h-10 rounded-full text-[11px] sm:text-xs font-semibold
                    border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300
                    transition-colors active:scale-[0.97] focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                        Ver auditoría
                    </a>

                    <a href="/superadmin/negocios/{{ negocio.id }}/ver-como"
                       class="inline-flex justify-center items-center px-4 h-10 rounded-full text-[11px] sm:text-xs font-semibold
                    text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 transition-transform transition-colors active:scale-[0.97]
                    focus:outline-none focus:ring-2 focus:ring-cyan-400/60">
                        Ver como este negocio
                    </a>
                </div>
            </div>
        </header>

        {# =========================
        FORM: Segmento + Estado
        ========================= #}
        <div class="border-t border-slate-800 pt-4 space-y-4">

            {# ---- Segmento ---- #}
            <form action="/superadmin/negocios/{{ negocio.id }}/segmento"
                  method="post"
                  class="space-y-3">

                <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
                    <div class="sm:col-span-8 space-y-1.5">
                        <label for="segmento" class="text-[11px] font-semibold text-slate-200">
                            Segmento del negocio
                        </label>

                        <select id="segmento"
                                name="segmento"
                                class="w-full h-10 rounded-xl border border-slate-700 bg-slate-900 px-3 text-sm text-slate-100
                           focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400">
                            <option value="emprendedor" {% if seg_val=="emprendedor" %}selected{% endif %}>Emprendedor</option>
                            <option value="pyme" {% if seg_val=="pyme" %}selected{% endif %}>Pyme</option>
                            <option value="enterprise" {% if seg_val=="enterprise" %}selected{% endif %}>Enterprise</option>
                        </select>
                    </div>

                    <div class="sm:col-span-4">
                        <button type="submit"
                                class="w-full h-10 inline-flex justify-center items-center px-4 rounded-full text-[11px] sm:text-xs font-semibold
                           text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 shadow-sm active:scale-[0.97]
                           transition-transform transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-400/60">
                            Guardar segmento
                        </button>
                    </div>
                </div>

                <p class="text-[11px] text-slate-400">
                    El segmento modifica el <span class="text-slate-200 font-medium">entitlements snapshot</span>
                    (feature gates / límites) y es base para pricing y elegibilidad de módulos.
                </p>
            </form>

            {# ---- Estado ---- #}
            <form action="/superadmin/negocios/{{ negocio.id }}/estado"
                  method="post"
                  class="space-y-3">

                <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
                    <div class="sm:col-span-8 space-y-1.5">
                        <label for="estado" class="text-[11px] font-semibold text-slate-200">
                            Estado del negocio
                        </label>

                        <select id="estado"
                                name="estado"
                                class="w-full h-10 rounded-xl border border-slate-700 bg-slate-900 px-3 text-sm text-slate-100
                           focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400">
                            <option value="activo" {% if estado_val=="activo" %}selected{% endif %}>Activo</option>
                            <option value="suspendido" {% if estado_val=="suspendido" %}selected{% endif %}>Suspendido</option>
                        </select>
                    </div>

                    <div class="sm:col-span-4">
                        <button type="submit"
                                class="w-full h-10 inline-flex justify-center items-center px-4 rounded-full text-[11px] sm:text-xs font-semibold
                           text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 shadow-sm active:scale-[0.97]
                           transition-transform transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-400/60">
                            Guardar estado
                        </button>
                    </div>
                </div>

                <p class="text-[11px] text-slate-400">
                    Suspender bloquea acceso operativo. Las suscripciones por módulo se mantienen para auditoría.
                </p>
            </form>

        </div>
    </section>

    {# =========================
    SUSCRIPCIONES POR MÓDULO
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-5 sm:py-6 space-y-4">

        <header class="space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                SaaS modular
            </p>
            <h3 class="text-sm sm:text-base font-semibold text-slate-100">
                Suscripciones por módulo
            </h3>
            <p class="text-[11px] text-slate-400 max-w-2xl">
                Refleja la verdad: enabled/status/period/cancel_at_period_end por módulo.
            </p>
        </header>

        {% if modules and modules|length > 0 %}

        {# MOBILE: cards #}
        <div class="space-y-3 md:hidden">
            {% for m in modules %}
            <article class="rounded-2xl border border-slate-800 bg-slate-900 px-3 py-3 space-y-3">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <p class="text-[11px] font-semibold text-slate-100 truncate">{{ m.label }}</p>
                        <p class="text-[10px] text-slate-500">Slug: {{ m.slug }}</p>
                    </div>

                    <div class="flex flex-col items-end gap-1">
                        {{ badge_enabled(m.enabled) }}
                        {{ badge_status(m.status) }}
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 text-[11px] text-slate-300">
                    <div>
                        <p class="text-[10px] text-slate-500">Período hasta</p>
                        <p class="font-medium">{{ fmt_date(m.period_end) }}</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500">Cancelación programada</p>
                        <p class="font-medium">{{ "Sí" if m.cancel_at_period_end else "No" }}</p>
                    </div>
                </div>

                <div class="pt-1 flex flex-wrap gap-2">
                    {% if not m.enabled %}
                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/activate" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-semibold
                               text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 active:scale-[0.97] transition
                               focus:outline-none focus:ring-2 focus:ring-cyan-400/60">
                            Activar (trial)
                        </button>
                    </form>
                    {% else %}
                    {% if m.cancel_at_period_end %}
                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/reactivate" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                 border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition
                                 focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                            Reactivar
                        </button>
                    </form>
                    {% else %}
                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/cancel" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                 border border-rose-500/40 text-rose-200 bg-rose-500/10 hover:bg-rose-500/15 transition
                                 focus:outline-none focus:ring-2 focus:ring-rose-400/50">
                            Cancelar fin período
                        </button>
                    </form>
                    {% endif %}

                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/renew-now" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                               border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition
                               focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                            Forzar renovación
                        </button>
                    </form>

                    {% set st = norm_str(m.status) %}
                    {% if st != "suspended" and st != "suspenDido"|lower %}
                    <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/suspend" method="post">
                        <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                 border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition
                                 focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                            Suspender
                        </button>
                    </form>
                    {% endif %}
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>

        {# DESKTOP/TABLET: table #}
        <div class="hidden md:block border border-slate-800 rounded-2xl overflow-x-auto bg-slate-900/80">
            <table class="min-w-full text-[11px] sm:text-xs">
                <thead class="bg-slate-900/90">
                    <tr class="font-medium text-slate-400 uppercase tracking-wide">
                        <th class="px-4 py-2 text-left">Módulo</th>
                        <th class="px-4 py-2 text-left">Slug</th>
                        <th class="px-4 py-2 text-left">Status</th>
                        <th class="px-4 py-2 text-left">Enabled</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap">Período hasta</th>
                        <th class="px-4 py-2 text-left whitespace-nowrap">Cancelación</th>
                        <th class="px-4 py-2 text-left">Acciones</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-slate-800/80">
                    {% for m in modules %}
                    <tr class="hover:bg-slate-900 align-top">
                        <td class="px-4 py-2 text-slate-100 font-medium">{{ m.label }}</td>
                        <td class="px-4 py-2 text-slate-300">{{ m.slug }}</td>
                        <td class="px-4 py-2">{{ badge_status(m.status) }}</td>
                        <td class="px-4 py-2">{{ badge_enabled(m.enabled) }}</td>
                        <td class="px-4 py-2 text-slate-300 whitespace-nowrap">{{ fmt_date(m.period_end) }}</td>
                        <td class="px-4 py-2 text-slate-300 whitespace-nowrap">{{ "Sí" if m.cancel_at_period_end else "No" }}</td>
                        <td class="px-4 py-2">
                            <div class="flex flex-wrap gap-2">
                                {% if not m.enabled %}
                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/activate" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-semibold
                                     text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 active:scale-[0.97] transition
                                     focus:outline-none focus:ring-2 focus:ring-cyan-400/60">
                                        Activar
                                    </button>
                                </form>
                                {% else %}
                                {% if m.cancel_at_period_end %}
                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/reactivate" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                       border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition
                                       focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                                        Reactivar
                                    </button>
                                </form>
                                {% else %}
                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/cancel" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                       border border-rose-500/40 text-rose-200 bg-rose-500/10 hover:bg-rose-500/15 transition
                                       focus:outline-none focus:ring-2 focus:ring-rose-400/50">
                                        Cancelar
                                    </button>
                                </form>
                                {% endif %}

                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/renew-now" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                     border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition
                                     focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                                        Renovar ahora
                                    </button>
                                </form>

                                {% set st = norm_str(m.status) %}
                                {% if st != "suspended" %}
                                <form action="/superadmin/negocios/{{ negocio.id }}/modules/{{ m.slug }}/suspend" method="post">
                                    <button class="inline-flex items-center h-9 px-3 rounded-full text-[11px] font-medium
                                       border border-slate-700 text-slate-200 bg-slate-900 hover:border-cyan-400 hover:text-cyan-300 transition
                                       focus:outline-none focus:ring-2 focus:ring-cyan-400/50">
                                        Suspender
                                    </button>
                                </form>
                                {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% else %}
        <div class="rounded-xl border border-slate-800 bg-slate-900 px-4 py-3 text-xs sm:text-sm text-slate-300">
            No hay módulos registrados en entitlements para este negocio.
        </div>
        {% endif %}

    </section>

</div>
{% endblock %}
