<!-- templates/app/orbion_hub.html -->
{% extends "base/base_app.html" %}

{% block title %}ORBION · Plataforma{% endblock %}

{% block content %}
{% set u = user or {} %}
{% set acting_id = u.get("acting_negocio_id") %}
{% set acting_nombre = u.get("acting_negocio_nombre") %}
{% set is_superadmin = (u.get("rol") == "superadmin") %}
{% set is_superadmin_global = is_superadmin and not acting_id %}

{# ✅ negocio real desde snapshot #}
{% set neg = negocio_ctx or {} %}
{% set has_negocio_ctx = (neg is mapping) and (neg|length > 0) %}

<div class="space-y-6 sm:space-y-8 max-w-6xl mx-auto">

    <!-- Header -->
    <header class="flex items-start sm:items-center justify-between gap-3">
        <div class="min-w-0 space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Hub de módulos
            </p>
            <h1 class="text-base sm:text-lg font-semibold text-slate-100 tracking-tight truncate">
                Plataforma ORBION
            </h1>

            {% if is_superadmin and acting_id %}
            <p class="text-[11px] sm:text-xs text-slate-400 leading-snug max-w-xl">
                Estás operando en <span class="text-slate-200 font-medium">modo negocio</span>:
                <span class="text-cyan-300 font-semibold">{{ acting_nombre or ("Negocio #" ~ acting_id) }}</span>.
            </p>
            {% else %}
            <p class="text-[11px] sm:text-xs text-slate-400 leading-snug max-w-xl">
                Accede a los módulos de tu organización. Activa lo que necesitas hoy y escala cuando tu operación lo pida.
            </p>
            {% endif %}
        </div>

        <div class="shrink-0 flex items-center gap-2">
            {% if is_superadmin and acting_id %}
            <a href="/superadmin/salir-modo-negocio"
               class="inline-flex items-center rounded-full border border-rose-500/40 px-3 py-1.5
                      text-[11px] font-medium text-rose-200 bg-rose-500/10 hover:bg-rose-500/15
                      transition-colors">
                Salir modo negocio
            </a>
            {% endif %}
        </div>
    </header>

    <!-- SUPERADMIN GLOBAL: NO MOSTRAR MÓDULOS -->
    {% if is_superadmin_global %}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 sm:p-5 space-y-2">
        <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
            Modo superadmin global
        </p>
        <h2 class="text-sm sm:text-base font-semibold text-slate-100">
            Consola de administración ORBION
        </h2>
        <p class="text-[11px] sm:text-xs text-slate-400 max-w-2xl leading-snug">
            Desde aquí no se accede a módulos operacionales. Para operar módulos debes entrar en modo negocio
            (impersonación) desde la consola.
        </p>

        <div class="pt-2 flex flex-wrap gap-2">
            <a href="/superadmin/dashboard"
               class="inline-flex items-center rounded-full px-4 py-2 text-[11px] font-semibold
                      text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 active:scale-[0.97]
                      transition-transform transition-colors">
                Ir a consola superadmin →
            </a>

            <a href="/superadmin/negocios"
               class="inline-flex items-center rounded-full border border-slate-700 px-4 py-2
                      text-[11px] font-medium text-slate-200 bg-slate-900
                      hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                Ver negocios (impersonar) →
            </a>

            <a href="/superadmin/jobs"
               class="inline-flex items-center rounded-full border border-slate-700 px-4 py-2
                      text-[11px] font-medium text-slate-200 bg-slate-900
                      hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                Job Center →
            </a>
        </div>
    </section>

    {% else %}

    <!-- PANEL PLAN & ESTADO (solo admin negocio) -->
    {% set is_admin = (u and (u.get("rol") == "admin")) %}

    {% if is_admin and has_negocio_ctx %}
    {% set seg = (neg.get("segment") or neg.get("segmento") or "emprendedor") %}
    {% set seg = (seg|string)|lower %}

    {# ✅ contar solo enabled efectivos y calcular próximo corte desde period_end efectivo #}
    {% set ns = namespace(enabled_count=0, next_period_end=None) %}
    {% for m in (dashboard_modules or []) %}
    {% if m and (m.status != "coming_soon") %}
    {% if m.enabled %}
    {% set ns.enabled_count = ns.enabled_count + 1 %}
    {% if m.period_end %}
    {% if ns.next_period_end is none %}
    {% set ns.next_period_end = m.period_end %}
    {% else %}
    {% if m.period_end < ns.next_period_end %}
    {% set ns.next_period_end = m.period_end %}
    {% endif %}
    {% endif %}
    {% endif %}
    {% endif %}
    {% endif %}
    {% endfor %}

    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4 sm:p-5">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="min-w-0 space-y-1">
                <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                    Cuenta & plan
                </p>

                <div class="flex flex-wrap items-center gap-2">
                    <h2 class="text-sm sm:text-base font-semibold text-slate-100">
                        {{ neg.get("name") or neg.get("nombre") or "Tu negocio" }}
                    </h2>

                    <span class="text-[10px] px-2 py-1 rounded-full border border-slate-700 text-slate-300">
                        Segmento: {{ (seg)|capitalize }}
                    </span>

                    {% if ns.enabled_count > 0 %}
                    <span class="text-[10px] px-2 py-1 rounded-full border border-emerald-500/50 text-emerald-300">
                        Módulos activos: {{ ns.enabled_count }}
                    </span>
                    {% else %}
                    <span class="text-[10px] px-2 py-1 rounded-full border border-cyan-500/50 text-cyan-300">
                        Sin módulos activos
                    </span>
                    {% endif %}

                    {% if ns.next_period_end %}
                    <span class="text-[10px] px-2 py-1 rounded-full border border-slate-700 text-slate-300">
                        Próximo corte: {{ ns.next_period_end[:10] }}
                    </span>
                    {% endif %}
                </div>

                <p class="text-[11px] sm:text-xs text-slate-400 max-w-3xl">
                    Tu acceso a módulos y límites se administra por períodos. Revisa tu plan y habilita nuevos módulos cuando lo necesites.
                </p>
            </div>

            <div class="flex flex-wrap gap-2 justify-start lg:justify-end">
                <a href="/app/planes"
                   class="inline-flex items-center rounded-full px-4 py-2 text-[11px] font-semibold
                          text-slate-900 bg-[#00E4FF] hover:bg-cyan-300
                          active:scale-[0.97] transition-transform transition-colors">
                    Administrar suscripción
                </a>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- GRID DE MÓDULOS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-5">
        {% for m in (dashboard_modules or []) %}
        <article class="relative rounded-2xl border border-slate-800 bg-slate-900/50 p-4 sm:p-5 flex flex-col gap-3 sm:gap-4 hover:border-cyan-400/40 transition">
            <div class="absolute inset-0 rounded-2xl bg-cyan-500/5 blur-xl pointer-events-none"></div>

            <div class="relative flex items-start justify-between gap-3">
                <div class="min-w-0">
                    <h2 class="text-sm font-semibold text-slate-100">
                        {{ m.label }}
                    </h2>
                    <p class="mt-1 text-[11px] sm:text-xs text-slate-400">
                        {{ m.description }}
                    </p>
                </div>

                <span class="shrink-0 text-[10px] px-2 py-1 rounded-full border
                    {% if not m.enabled %}
                        border-slate-700 text-slate-400
                    {% elif m.status == 'trial' %}
                        border-cyan-400/60 text-cyan-300
                    {% elif m.status == 'active' %}
                        border-emerald-500/60 text-emerald-300
                    {% elif m.status in ('past_due', 'suspended') %}
                        border-amber-500/60 text-amber-300
                    {% else %}
                        border-slate-600 text-slate-300
                    {% endif %}">
                    {{ m.badge }}
                </span>
            </div>

            {% if m.enabled and m.metric_label %}
            <div class="space-y-1">
                <div class="flex justify-between text-[10px] text-slate-400">
                    <span>{{ m.metric_label }}</span>
                    <span>{{ cl_num(m.metric_used, 0) }} / {{ cl_num(m.metric_limit, 0) }}</span>
                </div>

                <div class="h-1.5 rounded-full bg-slate-800 overflow-hidden">
                    {% set pct = (m.metric_used / m.metric_limit * 100) if m.metric_limit and m.metric_limit > 0 else 0 %}
                    <div class="h-full
                         {% if pct < 80 %}
                            bg-emerald-400
                        {% elif pct < 100 %}
                            bg-amber-400
                        {% else %}
                            bg-red-500
                        {% endif %}"
                        style="width: {{ pct|round(0) }}%"></div>
                </div>
            </div>
            {% endif %}

            <div class="mt-auto pt-3 sm:pt-4 flex items-center justify-between gap-3 relative">
                {% if m.enabled and m.period_end %}
                <span class="text-[10px] text-slate-500">
                    Período hasta {{ m.period_end[:10] }}
                </span>
                {% else %}
                <span></span>
                {% endif %}

                {% if m.enabled %}
                <a href="{{ m.url }}"
                   class="inline-flex items-center gap-2 text-xs font-medium px-4 py-2 rounded-full bg-[#00E4FF]
                          text-slate-900 hover:bg-cyan-300 active:scale-[0.97] transition-transform transition-colors">
                    Abrir
                </a>
                {% else %}
                <a href="/app/planes"
                   class="inline-flex items-center gap-2 text-xs font-medium px-4 py-2 rounded-full
                          border border-cyan-500/50 text-cyan-300 hover:bg-cyan-500/10 transition">
                    Suscribirse
                </a>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>

    {% endif %} {# /endif superadmin_global #}

</div>
{% endblock %}
