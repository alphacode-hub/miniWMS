{# modules/inbound_orbion/templates/inbound_checklist_recepcion.html #}
{% extends "base/base_app.html" %}

{% block title %}
ORBION · Checklist · {{ recepcion.codigo_recepcion if recepcion else "Recepción" }}
{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}
{% set recep_codigo = recepcion.codigo_recepcion if recepcion and recepcion.codigo_recepcion else (recepcion.codigo if recepcion and recepcion.codigo else ("Recepción #" ~ recepcion.id if recepcion else "Recepción")) %}

{% set recep_estado = (recepcion.estado.value if recepcion and recepcion.estado else '') %}
{% set recepcion_cerrada = (recep_estado == 'CERRADO') %}

{# SIMPLE V2: solo lectura viene del backend (locked) o recepcion cerrada #}
{% set solo_lectura = (locked or recepcion_cerrada) %}

{% macro chk_badge_simple(resumen) -%}
  {%- set bloqueado = (resumen.get("bloqueado") if resumen else False) -%}
  {%- if bloqueado -%}
<span id="chkEstadoBadge"
      class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border
             bg-rose-500/10 text-rose-200 border-rose-500/40">
    BLOQUEADO
</span>
  {%- else -%}
<span id="chkEstadoBadge"
      class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border
             bg-slate-700/40 text-slate-100 border-slate-600">
    ACTIVO
</span>
  {%- endif -%}
{%- endmacro %}

{% macro estado_badge(estado) -%}
  {%- set x = (estado or "")|upper|trim -%}
  {%- if x == "CUMPLE" -%}
<span data-role="item-badge" data-state="CUMPLE"
      class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border bg-emerald-500/10 text-emerald-200 border-emerald-500/40">Cumple</span>
  {%- elif x == "NO_CUMPLE" -%}
<span data-role="item-badge" data-state="NO_CUMPLE"
      class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border bg-rose-500/10 text-rose-200 border-rose-500/40">No cumple</span>
  {%- elif x == "NA" -%}
<span data-role="item-badge" data-state="NA"
      class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border bg-slate-700/40 text-slate-100 border-slate-600">NA</span>
  {%- else -%}
<span data-role="item-badge" data-state="PENDIENTE"
      class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border bg-slate-700/40 text-slate-100 border-slate-600">Pendiente</span>
  {%- endif -%}
{%- endmacro %}


<div class="space-y-6 sm:space-y-8 max-w-5xl mx-auto">

    {# =========================
    HEADER
    ========================= #}
    <header class="flex items-start sm:items-center justify-between gap-3">
        <div class="min-w-0 space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Módulo inbound · Recepción · Checklist
            </p>

            <h1 class="text-base sm:text-lg font-semibold text-slate-100 tracking-tight truncate">
                {{ recep_codigo }}
                <span class="text-slate-500 font-normal">
                    · {{ recepcion.proveedor.nombre if recepcion and recepcion.proveedor and recepcion.proveedor.nombre else "Sin proveedor" }}
                </span>
            </h1>

            <p class="text-[11px] sm:text-xs text-slate-400 leading-snug max-w-xl">
                {% if checklist and checklist.plantilla_nombre %}
                Plantilla: {{ checklist.plantilla_nombre }}
                {% else %}
                Checklist operativo de recepción
                {% endif %}
                {% if recep_estado %} · Estado recepción: {{ recep_estado }}{% endif %}
            </p>
        </div>

        <div class="shrink-0 flex items-center gap-2">
            {% if checklist %}
            {{ chk_badge_simple(checklist.resumen or {}) }}
            {% endif %}

            {% if solo_lectura %}
            <span class="inline-flex items-center rounded-full border border-emerald-500/40 bg-emerald-500/10
                        px-3 py-1 text-[10px] font-semibold text-emerald-200">
                Solo lectura
            </span>
            {% endif %}

            <a href="/inbound/recepciones/{{ recepcion.id if recepcion else '' }}"
               class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1.5
                      text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300
                      transition-colors">
                ← Volver
            </a>
        </div>
    </header>

    {# =========================
    ALERTAS (ok/error)
    ========================= #}
    {% if ok %}
    <section class="rounded-2xl border border-emerald-500/30 bg-emerald-500/10 px-3 py-3 sm:px-4 sm:py-4">
        <p class="text-xs font-semibold text-emerald-200">Listo</p>
        <p class="text-[11px] text-emerald-200/90 mt-1">{{ ok }}</p>
    </section>
    {% endif %}

    {% if error %}
    <section class="rounded-2xl border border-rose-500/30 bg-rose-500/10 px-3 py-3 sm:px-4 sm:py-4">
        <p class="text-xs font-semibold text-rose-200">No se pudo completar la acción</p>
        <p class="text-[11px] text-rose-200/90 mt-1 whitespace-pre-line">{{ error }}</p>
    </section>
    {% endif %}

    {% if locked and locked_reason %}
    <section class="rounded-2xl border border-slate-700 bg-slate-900/60 px-3 py-3 sm:px-4 sm:py-4">
        <p class="text-xs font-semibold text-slate-200">Modo solo lectura</p>
        <p class="text-[11px] text-slate-400 mt-1 whitespace-pre-line">{{ locked_reason }}</p>
    </section>
    {% endif %}

    {% if checklist %}
    {% set resumen = checklist.resumen or {} %}
    {% set pct = resumen.get("progreso_pct", 0) %}
    {% set total = resumen.get("items_total", 0) %}
    {% set respondidos = resumen.get("items_respondidos", 0) %}
    {% set req_total = resumen.get("requeridos_total", 0) %}
    {% set req_ok = resumen.get("requeridos_ok", 0) %}
    {% set req_pend = resumen.get("requeridos_pendientes", 0) %}
    {% set crit_bad = resumen.get("criticos_no_cumple", 0) %}
    {% set bloqueado = resumen.get("bloqueado", False) %}

    {# =========================
    RESUMEN
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-4 sm:py-5 space-y-3">
        <div class="flex items-start justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wide">Resumen</p>
                <p class="text-[11px] text-slate-400">Autosave activo. Requeridos OK para “completar” operativo.</p>
            </div>

            <span id="pctBadge" class="inline-flex items-center rounded-full border border-slate-800 bg-slate-950/40 px-3 py-1 text-[10px] font-semibold text-slate-300">
                {{ pct }}%
            </span>
        </div>

        <div class="h-2 rounded-full bg-slate-800 overflow-hidden">
            <div id="pctBar" class="h-full bg-cyan-400/80" style="width: {{ pct }}%"></div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
            <div class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-3">
                <p class="text-[10px] text-slate-400 uppercase tracking-wide">Respondidos</p>
                <p class="mt-1 text-sm font-semibold text-slate-100">
                    <span id="respondidosTxt">{{ respondidos }}</span>
                    <span class="text-[11px] font-normal text-slate-400">/ <span id="totalTxt">{{ total }}</span></span>
                </p>
                <p class="text-[10px] text-slate-500 mt-1">Cuenta si estado ≠ PENDIENTE.</p>
            </div>

            <div class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-3">
                <p class="text-[10px] text-slate-400 uppercase tracking-wide">Requeridos OK</p>
                <p class="mt-1 text-sm font-semibold text-slate-100">
                    <span id="reqOkTxt">{{ req_ok }}</span>
                    <span class="text-[11px] font-normal text-slate-400">/ <span id="reqTotTxt">{{ req_total }}</span></span>
                </p>
                <p id="reqPendLine" class="text-[10px] mt-1 {{ 'text-amber-300' if req_pend>0 else 'text-slate-500' }}">
                    {% if req_pend > 0 %}
                    Faltan <span id="reqPendTxt">{{ req_pend }}</span> requeridos.
                    {% else %}
                    Listo.
                    {% endif %}
                </p>
            </div>

            <div class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-3">
                <p class="text-[10px] text-slate-400 uppercase tracking-wide">Críticos NO CUMPLE</p>
                <p class="mt-1 text-sm font-semibold {{ 'text-rose-200' if crit_bad>0 else 'text-slate-100' }}">
                    <span id="critTxt">{{ crit_bad }}</span>
                </p>
                <p class="text-[10px] text-slate-500 mt-1">Si &gt; 0 → bloqueo.</p>
            </div>

            <div class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-3">
                <p class="text-[10px] text-slate-400 uppercase tracking-wide">Estado</p>
                <p class="mt-1 text-sm font-semibold {{ 'text-rose-200' if bloqueado else 'text-slate-100' }}">
                    <span id="estadoTxt">{{ "BLOQUEADO" if bloqueado else "ACTIVO" }}</span>
                </p>
                <p class="text-[10px] text-slate-500 mt-1">Recepción cerrada inmoviliza.</p>
            </div>
        </div>

        <div class="flex items-center justify-between gap-3 pt-2">
            <div id="saveStatus" class="text-[11px] text-slate-500">
                {% if solo_lectura %}Solo lectura.{% else %}Listo.{% endif %}
            </div>

            <span class="inline-flex items-center rounded-full border border-slate-700 px-4 py-1.5 text-[11px] font-semibold text-slate-400 bg-slate-900/40">
                Autosave activo
            </span>
        </div>
    </section>

    {# =========================
    SECCIONES
    ========================= #}
    <section class="space-y-4">
        {% for sec in (checklist.secciones or []) %}
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 overflow-hidden" data-role="section" data-sec="{{ sec.codigo }}">
            <div class="px-3 py-3 sm:px-4 sm:py-4 border-b border-slate-800 flex items-center justify-between gap-2">
                <div class="min-w-0">
                    <p class="text-[11px] font-semibold text-slate-300">{{ sec.titulo }}</p>
                    {% set sres = sec.resumen or {} %}
                    {% set spct = sres.get("progreso_pct", 0) %}
                    {% set stot = sres.get("items_total", 0) %}
                    {% set sresp = sres.get("items_respondidos", 0) %}

                    {# ✅ NUEVO: nodos actualizables por JS #}
                    <p class="text-[10px] text-slate-500">
                        <span data-role="sec-meta" data-sec="{{ sec.codigo }}">
                            {{ sec.codigo }} · {{ sresp }}/{{ stot }} · {{ spct }}%
                        </span>
                    </p>
                </div>

                <div class="h-2 w-40 rounded-full bg-slate-800 overflow-hidden">
                    <div data-role="sec-bar" data-sec="{{ sec.codigo }}"
                         class="h-full bg-cyan-400/80"
                         style="width: {{ spct }}%"></div>
                </div>
            </div>

            <div class="divide-y divide-slate-800">
                {% for it in (sec.items or []) %}
                {% set est = (it.estado|string)|upper|trim if it.estado else "PENDIENTE" %}
                {% if est in ["", "NONE"] %}{% set est = "PENDIENTE" %}{% endif %}

                <div class="px-3 py-4 sm:px-4 sm:py-5 checklist-item"
                     data-item-id="{{ it.item_id }}"
                     data-sololectura="{{ '1' if solo_lectura else '0' }}"
                     data-estado="{{ est }}"
                     data-role="item">
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0 space-y-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <p class="text-xs font-semibold text-slate-100 truncate">{{ it.nombre }}</p>

                                {% if it.requerido %}
                                <span class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border
                                             bg-amber-500/10 text-amber-200 border-amber-500/40">REQUERIDO</span>
                                {% endif %}

                                {% if it.critico %}
                                <span class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border
                                             bg-rose-500/10 text-rose-200 border-rose-500/40">CRÍTICO</span>
                                {% endif %}

                                {% if it.codigo %}
                                <span class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border
                                             bg-slate-700/40 text-slate-100 border-slate-600" data-role="item-code">
                                    {{ it.codigo }}
                                </span>
                                {% endif %}
                            </div>

                            {% if it.descripcion %}
                            <p class="text-[11px] text-slate-400">{{ it.descripcion }}</p>
                            {% endif %}
                        </div>

                        <div class="shrink-0">
                            {{ estado_badge(est) }}
                        </div>
                    </div>

                    <div class="mt-3 grid grid-cols-1 lg:grid-cols-12 gap-3">
                        <div class="lg:col-span-8 space-y-3">
                            <div class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-3 space-y-2">
                                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wide">Evaluación</p>

                                <div class="flex flex-wrap items-center gap-2">
                                    {% set dis = "opacity-50 pointer-events-none" if solo_lectura else "" %}
                                    <button type="button" class="chk-pill {{ dis }}" data-set="PENDIENTE">Pendiente</button>
                                    <button type="button" class="chk-pill {{ dis }}" data-set="CUMPLE">Cumple</button>
                                    <button type="button" class="chk-pill {{ dis }}" data-set="NO_CUMPLE">No cumple</button>
                                    <button type="button" class="chk-pill {{ dis }}" data-set="NA">NA</button>
                                </div>

                                {% if it.codigo == "TEMP_APLICA" %}
                                <p class="text-[10px] text-slate-500">
                                    Si marcas <span class="font-semibold text-slate-300">NA</span>, se ocultarán los ítems de temperatura.
                                </p>
                                {% endif %}
                            </div>
                        </div>

                        <div class="lg:col-span-4">
                            <div class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-3 h-full space-y-2">
                                <label class="block text-[11px] font-semibold text-slate-400 uppercase tracking-wide">Nota (opcional)</label>
                                <textarea rows="3"
                                          class="chk-note w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2
                                                 text-xs sm:text-sm text-slate-100 placeholder-slate-500 focus:outline-none
                                                 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 disabled:opacity-50"
                                          placeholder="Observación breve..."
                                          {% if solo_lectura %}disabled{% endif %}>{{ it.nota if it.nota else '' }}</textarea>
                                <p class="text-[10px] text-slate-500">Autosave: se guarda al cambiar o escribir (debounce).</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </section>
    {% endif %}
</div>

<style>
    .chk-pill {
        border-radius: 9999px;
    }
</style>

<script>
(function () {
  const SOLO = {{ "true" if solo_lectura else "false" }};
  const recepId = {{ recepcion.id if recepcion else "null" }};
  if (!recepId) return;

  const statusEl = document.getElementById("saveStatus");

  function setStatus(txt, isErr) {
    if (!statusEl) return;
    statusEl.textContent = txt;
    statusEl.className = "text-[11px] " + (isErr ? "text-rose-300" : "text-slate-500");
  }

  function updateResumen(res) {
    if (!res) return;

    const pct = res.progreso_pct ?? 0;
    const total = res.items_total ?? 0;
    const resp = res.items_respondidos ?? 0;
    const reqT = res.requeridos_total ?? 0;
    const reqO = res.requeridos_ok ?? 0;
    const reqP = res.requeridos_pendientes ?? 0;
    const crit = res.criticos_no_cumple ?? 0;
    const bloqueado = !!res.bloqueado;

    const pctBadge = document.getElementById("pctBadge");
    const pctBar = document.getElementById("pctBar");
    const respondidosTxt = document.getElementById("respondidosTxt");
    const totalTxt = document.getElementById("totalTxt");
    const reqTotTxt = document.getElementById("reqTotTxt");
    const reqOkTxt = document.getElementById("reqOkTxt");
    const reqPendLine = document.getElementById("reqPendLine");
    const critTxt = document.getElementById("critTxt");
    const estadoTxt = document.getElementById("estadoTxt");

    if (pctBadge) pctBadge.textContent = pct + "%";
    if (pctBar) pctBar.style.width = pct + "%";
    if (respondidosTxt) respondidosTxt.textContent = String(resp);
    if (totalTxt) totalTxt.textContent = String(total);
    if (reqTotTxt) reqTotTxt.textContent = String(reqT);
    if (reqOkTxt) reqOkTxt.textContent = String(reqO);
    if (critTxt) critTxt.textContent = String(crit);

    if (estadoTxt) {
      estadoTxt.textContent = bloqueado ? "BLOQUEADO" : "ACTIVO";
      estadoTxt.className = "font-semibold " + (bloqueado ? "text-rose-200" : "text-slate-100");
    }

    if (reqPendLine) {
      if (reqP > 0) {
        reqPendLine.className = "text-[10px] mt-1 text-amber-300";
        reqPendLine.textContent = "Faltan " + reqP + " requeridos.";
      } else {
        reqPendLine.className = "text-[10px] mt-1 text-slate-500";
        reqPendLine.textContent = "Listo.";
      }
    }

    const chkBadge = document.getElementById("chkEstadoBadge");
    if (chkBadge) {
      if (bloqueado) {
        chkBadge.textContent = "BLOQUEADO";
        chkBadge.className = "inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border bg-rose-500/10 text-rose-200 border-rose-500/40";
      } else {
        chkBadge.textContent = "ACTIVO";
        chkBadge.className = "inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border bg-slate-700/40 text-slate-100 border-slate-600";
      }
    }
  }

  // ✅ NUEVO: actualizar barras/contador por sección
  function updateSecciones(secciones) {
    if (!Array.isArray(secciones)) return;

    secciones.forEach((s) => {
      const codigo = (s.codigo || "").toString().trim();
      const r = s.resumen || {};
      if (!codigo) return;

      const total = r.items_total ?? 0;
      const resp = r.items_respondidos ?? 0;
      const pct = r.progreso_pct ?? 0;

      const meta = document.querySelector(`[data-role="sec-meta"][data-sec="${codigo}"]`);
      if (meta) meta.textContent = `${codigo} · ${resp}/${total} · ${pct}%`;

      const bar = document.querySelector(`[data-role="sec-bar"][data-sec="${codigo}"]`);
      if (bar) bar.style.width = `${pct}%`;
    });
  }

  function pillClass(state, active) {
    const base = "inline-flex items-center rounded-full px-3 py-1.5 text-[11px] font-semibold border transition-colors";
    if (!active) return base + " border-slate-700 text-slate-300 hover:border-cyan-400 hover:text-cyan-300";
    if (state === "CUMPLE") return base + " bg-emerald-500/10 text-emerald-200 border-emerald-500/40";
    if (state === "NO_CUMPLE") return base + " bg-rose-500/10 text-rose-200 border-rose-500/40";
    if (state === "NA") return base + " bg-slate-700/40 text-slate-100 border-slate-600";
    return base + " bg-slate-700/40 text-slate-100 border-slate-600";
  }

  function badgeClass(state) {
    const base = "inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border";
    if (state === "CUMPLE") return base + " bg-emerald-500/10 text-emerald-200 border-emerald-500/40";
    if (state === "NO_CUMPLE") return base + " bg-rose-500/10 text-rose-200 border-rose-500/40";
    return base + " bg-slate-700/40 text-slate-100 border-slate-600";
  }

  function badgeLabel(state) {
    if (state === "CUMPLE") return "Cumple";
    if (state === "NO_CUMPLE") return "No cumple";
    if (state === "NA") return "NA";
    return "Pendiente";
  }

  function setEstadoUI(itemEl, state) {
    if (!itemEl) return;
    itemEl.setAttribute("data-estado", state);

    const pills = itemEl.querySelectorAll(".chk-pill");
    pills.forEach((p) => {
      const s = (p.getAttribute("data-set") || "PENDIENTE").toUpperCase();
      const active = (s === state);
      const disabled = p.classList.contains("pointer-events-none");
      p.className = "chk-pill " + (disabled ? "opacity-50 pointer-events-none " : "") + pillClass(s, active);
    });

    const badge = itemEl.querySelector('[data-role="item-badge"]');
    if (badge) {
      badge.setAttribute("data-state", state);
      badge.className = badgeClass(state);
      badge.textContent = badgeLabel(state);
    }

    itemEl.classList.add("ring-2", "ring-cyan-500/30");
    setTimeout(() => itemEl.classList.remove("ring-2", "ring-cyan-500/30"), 250);
  }

  function shouldHideTemp() {
    const tempItem = Array.from(document.querySelectorAll('.checklist-item[data-role="item"]')).find((it) => {
      const chip = it.querySelector('[data-role="item-code"]');
      return chip && (chip.textContent || "").trim() === "TEMP_APLICA";
    });
    if (!tempItem) return false;
    const v = (tempItem.getAttribute("data-estado") || "PENDIENTE").toUpperCase();
    return v === "NA";
  }

  function applyTempVisibility() {
    const hide = shouldHideTemp();
    const all = Array.from(document.querySelectorAll('.checklist-item[data-role="item"]'));
    all.forEach((it) => {
      const chip = it.querySelector('[data-role="item-code"]');
      const code = chip ? (chip.textContent || "").trim().toUpperCase() : "";
      if (!code) return;

      if (code.startsWith("TEMP_") && code !== "TEMP_APLICA") {
        it.style.display = hide ? "none" : "";
      }
    });
  }

  const timers = new Map();
  const inFlight = new Map();

  function debouncedSave(itemEl, ms) {
    const key = itemEl.getAttribute("data-item-id") || "";
    if (timers.has(key)) clearTimeout(timers.get(key));
    timers.set(key, setTimeout(() => autosave(itemEl), ms));
  }

  async function autosave(itemEl) {
    if (SOLO) return;
    if (!itemEl) return;

    const itemId = parseInt(itemEl.getAttribute("data-item-id"), 10);
    const estado = (itemEl.getAttribute("data-estado") || "PENDIENTE").toUpperCase();
    const notaEl = itemEl.querySelector(".chk-note");
    const nota = notaEl ? (notaEl.value || "") : "";

    if (inFlight.has(String(itemId))) {
      try { inFlight.get(String(itemId)).abort(); } catch (_) {}
      inFlight.delete(String(itemId));
    }
    const controller = new AbortController();
    inFlight.set(String(itemId), controller);

    setStatus("Guardando…", false);

    try {
      const res = await fetch(`/inbound/recepciones/${recepId}/checklist/autosave`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ item_id: itemId, estado: estado, nota: nota }),
        signal: controller.signal
      });

      const data = await res.json().catch(() => ({}));
      inFlight.delete(String(itemId));

      if (!res.ok || !data.ok) {
        setStatus((data && data.error) ? data.error : "Error al guardar.", true);
        return;
      }

      updateResumen(data.resumen);
      updateSecciones(data.secciones);

      if (data.item_updated && data.item_updated.item_id) {
        const upd = data.item_updated;
        const target = document.querySelector(`.checklist-item[data-item-id="${upd.item_id}"]`);
        if (target) {
          const st = ((upd.estado || "PENDIENTE") + "").toUpperCase();
          setEstadoUI(target, st);
          const note = target.querySelector(".chk-note");
          if (note && typeof upd.nota === "string") {
            if (document.activeElement !== note) note.value = upd.nota;
          }
        }
      }

      if ((itemEl.querySelector('[data-role="item-code"]')?.textContent || "").trim() === "TEMP_APLICA") {
        applyTempVisibility();
      }

      setStatus("Guardado.", false);

    } catch (e) {
      if (e && e.name === "AbortError") return;
      setStatus("Error inesperado al guardar.", true);
    }
  }

  // Init UI de pills/badges según data-estado
  document.querySelectorAll('.checklist-item[data-role="item"]').forEach((itemEl) => {
    const state = (itemEl.getAttribute("data-estado") || "PENDIENTE").toUpperCase();
    setEstadoUI(itemEl, state);
  });

  applyTempVisibility();

  document.addEventListener("click", (ev) => {
    const btn = ev.target && ev.target.closest ? ev.target.closest(".chk-pill") : null;
    if (!btn) return;

    const itemEl = btn.closest(".checklist-item");
    if (!itemEl) return;
    if (itemEl.getAttribute("data-sololectura") === "1") return;

    const state = (btn.getAttribute("data-set") || "PENDIENTE").toUpperCase();
    setEstadoUI(itemEl, state);
    debouncedSave(itemEl, 60);
  });

  document.addEventListener("input", (ev) => {
    const el = ev.target;
    if (!el) return;

    const itemEl = el.closest ? el.closest(".checklist-item") : null;
    if (!itemEl) return;
    if (itemEl.getAttribute("data-sololectura") === "1") return;

    if (el.classList.contains("chk-note")) {
      debouncedSave(itemEl, 450);
    }
  });
})();
</script>

{% endblock %}
