{% extends "base/base_app.html" %}
{% block title %}Inbound · Analytics{% endblock %}

{% block content %}
<div class="w-full max-w-6xl mx-auto px-4 py-5 sm:py-7 space-y-5">

    <!-- Header -->
    <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
            <h1 class="text-lg sm:text-xl font-semibold text-slate-100">Analytics inbound</h1>
            <p class="text-xs sm:text-sm text-slate-300 mt-1">
                KPIs operativos + calidad + eficiencia. Baseline v1 → v3 (snapshots + scoring).
            </p>
            {% if analytics and analytics.meta and analytics.meta.snapshot_id %}
            <p class="text-xs text-slate-400 mt-1">
                Snapshot: <span class="text-slate-200">#{{ analytics.meta.snapshot_id }}</span>
                {% if analytics.meta.snapshot_creado_en %}· {{ analytics.meta.snapshot_creado_en }}{% endif %}
            </p>
            {% endif %}
        </div>

        <div class="flex items-center gap-2 shrink-0">
            <a href="/inbound/recepciones"
               class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1.5
                text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                ← Volver a recepción
            </a>
        </div>
    </div>

    <!-- Alerts -->
    {% if error %}
    <div class="rounded-xl border border-rose-500/20 bg-rose-500/10 px-4 py-3 text-rose-100">
        <div class="text-sm font-semibold">Error</div>
        <div class="text-sm text-rose-100/90 mt-1">{{ error }}</div>
    </div>
    {% endif %}
    {% if ok %}
    <div class="rounded-xl border border-emerald-500/20 bg-emerald-500/10 px-4 py-3 text-emerald-100">
        <div class="text-sm font-semibold">Listo</div>
        <div class="text-sm text-emerald-100/90 mt-1">{{ ok }}</div>
    </div>
    {% endif %}

    <!-- Filtros -->
    <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4">
        <form method="get" action="/inbound/analytics" class="grid grid-cols-1 md:grid-cols-12 gap-3">
            <div class="md:col-span-3">
                <label class="block text-xs font-semibold text-slate-300 mb-1">Desde</label>
                <input type="date" name="desde" value="{{ filtros.desde }}"
                       class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700/60 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400/30" />
            </div>
            <div class="md:col-span-3">
                <label class="block text-xs font-semibold text-slate-300 mb-1">Hasta</label>
                <input type="date" name="hasta" value="{{ filtros.hasta }}"
                       class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700/60 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400/30" />
            </div>
            <div class="md:col-span-4">
                <label class="block text-xs font-semibold text-slate-300 mb-1">Proveedor</label>
                <select name="proveedor_id"
                        class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700/60 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-400/30">
                    <option value="">— Todos —</option>
                    {% for p in (proveedores or []) %}
                    <option value="{{ p.id }}" {% if filtros.proveedor_id and (filtros.proveedor_id|string)==(p.id|string) %}selected{% endif %}>
                        {{ p.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="md:col-span-2 flex items-end gap-2">
                <button type="submit"
                        class="w-full px-3 py-2 rounded-lg bg-cyan-500/90 hover:bg-cyan-500 text-cyan-950 text-xs font-semibold border border-cyan-400/40">
                    Aplicar
                </button>
            </div>
        </form>

        <div class="mt-3 flex flex-wrap items-center gap-2">
            <a href="/inbound/analytics/export.csv?desde={{ filtros.desde }}&hasta={{ filtros.hasta }}&proveedor_id={{ filtros.proveedor_id }}"
               class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-semibold border border-slate-700/60">
                Exportar CSV
            </a>

            <form method="post" action="/inbound/analytics/snapshots/crear?desde={{ filtros.desde }}&hasta={{ filtros.hasta }}&proveedor_id={{ filtros.proveedor_id }}">
                <button type="submit"
                        class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-semibold border border-slate-700/60">
                    Crear snapshot
                </button>
            </form>

            {% if snapshots %}
            <div class="text-xs text-slate-400 ml-auto">
                Snapshots recientes:
                {% for s in snapshots %}
                <a href="/inbound/analytics/snapshots/{{ s.id }}"
                   class="ml-2 inline-flex items-center rounded-full border border-slate-700 px-3 py-1 text-[10px] font-semibold text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                    #{{ s.id }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    {% if analytics %}
    {% set k = analytics.kpis %}
    <!-- KPI Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-6 gap-3">
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4">
            <div class="text-[11px] text-slate-400">Recepciones</div>
            <div class="text-xl font-semibold text-slate-100 mt-1">{{ k.recepciones_total }}</div>
        </div>
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4">
            <div class="text-[11px] text-slate-400">Cerradas</div>
            <div class="text-xl font-semibold text-slate-100 mt-1">{{ k.recepciones_cerradas }}</div>
        </div>
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4">
            <div class="text-[11px] text-slate-400">Kg recibidos</div>
            <div class="text-xl font-semibold text-slate-100 mt-1">{{ k.kg_recibidos }}</div>
        </div>
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4">
            <div class="text-[11px] text-slate-400">Incidencias</div>
            <div class="text-xl font-semibold text-slate-100 mt-1">{{ k.incidencias_total }}</div>
        </div>
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4">
            <div class="text-[11px] text-slate-400">Checklist</div>
            <div class="text-xl font-semibold text-slate-100 mt-1">{{ k.checklist_pct }}%</div>
        </div>
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4">
            <div class="text-[11px] text-slate-400">Arribo→Cierre</div>
            <div class="text-xl font-semibold text-slate-100 mt-1">{{ k.sla_arribo_cierre_min }}</div>
            <div class="text-[10px] text-slate-500">min promedio</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4 lg:col-span-1">
            <div class="text-sm font-semibold text-slate-100">Recepciones por estado</div>
            <canvas id="chartEstados" class="mt-3"></canvas>
        </div>
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4 lg:col-span-1">
            <div class="text-sm font-semibold text-slate-100">Incidencias por criticidad</div>
            <canvas id="chartCrit" class="mt-3"></canvas>
        </div>
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60 p-4 lg:col-span-1">
            <div class="text-sm font-semibold text-slate-100">Kg recibidos por día</div>
            <canvas id="chartKg" class="mt-3"></canvas>
        </div>
    </div>

    <!-- v3 Scoring -->
    <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60">
        <div class="p-4 border-b border-slate-800/60">
            <div class="flex items-center justify-between">
                <div class="text-sm font-semibold text-slate-100">Scoring de proveedores (v3)</div>
                <div class="text-xs text-slate-400">0–100 (calidad + puntualidad + eficiencia)</div>
            </div>
        </div>
        <div class="p-4 overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="text-slate-400 text-xs">
                    <tr class="border-b border-slate-800/60">
                        <th class="text-left py-2 pr-3">Proveedor</th>
                        <th class="text-right py-2 px-3">Score</th>
                        <th class="text-right py-2 px-3">Recepciones</th>
                        <th class="text-right py-2 px-3">Checklist%</th>
                        <th class="text-right py-2 px-3">Inc/Rec</th>
                        <th class="text-right py-2 px-3">ETA→Arribo (min)</th>
                        <th class="text-right py-2 pl-3">Arribo→Cierre (min)</th>
                    </tr>
                </thead>
                <tbody class="text-slate-200">
                    {% for row in (scoring or []) %}
                    <tr class="border-b border-slate-800/40">
                        <td class="py-2 pr-3">{{ row.proveedor_nombre }}</td>
                        <td class="py-2 px-3 text-right font-semibold">
                            {% set s = row.score %}
                            {% if s >= 85 %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-emerald-500/15 text-emerald-200 border border-emerald-500/20">{{ s }}</span>
                            {% elif s >= 70 %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-cyan-500/15 text-cyan-200 border border-cyan-500/20">{{ s }}</span>
                            {% else %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-amber-400/15 text-amber-200 border border-amber-400/20">{{ s }}</span>
                            {% endif %}
                        </td>
                        <td class="py-2 px-3 text-right">{{ row.recepciones }}</td>
                        <td class="py-2 px-3 text-right">{{ row.checklist_pct }}</td>
                        <td class="py-2 px-3 text-right">{{ row.inc_rate }}</td>
                        <td class="py-2 px-3 text-right">{{ row.eta_arribo_min }}</td>
                        <td class="py-2 pl-3 text-right">{{ row.arribo_cierre_min }}</td>
                    </tr>
                    {% endfor %}
                    {% if not scoring %}
                    <tr><td colspan="7" class="py-4 text-center text-slate-400">Sin datos suficientes para scoring.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tablas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60">
            <div class="p-4 border-b border-slate-800/60">
                <div class="text-sm font-semibold text-slate-100">Por proveedor</div>
            </div>
            <div class="p-4 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-slate-400 text-xs">
                        <tr class="border-b border-slate-800/60">
                            <th class="text-left py-2 pr-3">Proveedor</th>
                            <th class="text-right py-2 px-3">Recep</th>
                            <th class="text-right py-2 px-3">Kg</th>
                            <th class="text-right py-2 px-3">Inc</th>
                            <th class="text-right py-2 pl-3">Checklist%</th>
                        </tr>
                    </thead>
                    <tbody class="text-slate-200">
                        {% for row in (analytics.tablas.por_proveedor or []) %}
                        <tr class="border-b border-slate-800/40">
                            <td class="py-2 pr-3">{{ row.proveedor_nombre }}</td>
                            <td class="py-2 px-3 text-right">{{ row.recepciones }}</td>
                            <td class="py-2 px-3 text-right">{{ row.kg }}</td>
                            <td class="py-2 px-3 text-right">{{ row.incidencias }}</td>
                            <td class="py-2 pl-3 text-right">{{ row.checklist_pct }}</td>
                        </tr>
                        {% endfor %}
                        {% if not analytics.tablas.por_proveedor %}
                        <tr><td colspan="5" class="py-4 text-center text-slate-400">Sin datos.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="rounded-2xl bg-slate-900/50 border border-slate-800/60">
            <div class="p-4 border-b border-slate-800/60">
                <div class="text-sm font-semibold text-slate-100">Incidencias</div>
            </div>
            <div class="p-4 overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-slate-400 text-xs">
                        <tr class="border-b border-slate-800/60">
                            <th class="text-left py-2 pr-3">Tipo</th>
                            <th class="text-left py-2 px-3">Criticidad</th>
                            <th class="text-right py-2 pl-3">Total</th>
                        </tr>
                    </thead>
                    <tbody class="text-slate-200">
                        {% for row in (analytics.tablas.incidencias or []) %}
                        <tr class="border-b border-slate-800/40">
                            <td class="py-2 pr-3">{{ row.tipo }}</td>
                            <td class="py-2 px-3">{{ row.criticidad }}</td>
                            <td class="py-2 pl-3 text-right">{{ row.total }}</td>
                        </tr>
                        {% endfor %}
                        {% if not analytics.tablas.incidencias %}
                        <tr><td colspan="3" class="py-4 text-center text-slate-400">Sin incidencias en el rango.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% else %}
    <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 p-6 text-slate-300">
        Aún no hay analytics disponibles (o faltan datos). Crea recepciones, líneas, checklists o incidencias.
    </div>
    {% endif %}
</div>

<!-- Charts JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const analytics = {{ analytics|tojson if analytics else 'null' }};

  function mkBar(canvasId, labels, values, title){
    const ctx = document.getElementById(canvasId);
    if(!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: { labels: labels, datasets: [{ label: title, data: values }] },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  if(analytics){
    mkBar("chartEstados",
      (analytics.series.recepciones_por_estado.labels || []),
      (analytics.series.recepciones_por_estado.values || []),
      "Recepciones"
    );

    mkBar("chartCrit",
      (analytics.series.incidencias_por_criticidad.labels || []),
      (analytics.series.incidencias_por_criticidad.values || []),
      "Incidencias"
    );

    mkBar("chartKg",
      (analytics.series.kg_por_dia.labels || []),
      (analytics.series.kg_por_dia.values || []),
      "Kg"
    );
  }
</script>
{% endblock %}
