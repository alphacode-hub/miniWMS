{% extends "base/base_app.html" %}

{% block title %}Inbound · Pallets{% endblock %}

{% block content %}
{% set recep_codigo = recepcion.codigo_recepcion if recepcion and recepcion.codigo_recepcion else (recepcion.codigo if recepcion and recepcion.codigo else ("Recepción #" ~ recepcion.id)) %}

<div class="w-full max-w-6xl mx-auto px-4 py-5 sm:py-7 space-y-5">

    <!-- Header -->
    <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
            <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wide">Módulo Inbound · Pallets</p>
            <h1 class="mt-1 text-xl sm:text-2xl font-semibold text-slate-100 truncate">
                {{ recep_codigo }} · Gestión de pallets
            </h1>
            <p class="mt-1 text-[12px] text-slate-400">
                Crea pallets, asigna líneas por modo (cantidad/peso) y luego reconcilia.
            </p>
        </div>

        <div class="shrink-0">
            <a href="/inbound/recepciones/{{ recepcion.id }}"
               class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1.5
                text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                ← Volver a recepción
            </a>
        </div>
    </div>

    <!-- Alerts (opcional si tus rutas usan querystring) -->
    {% set qs_success = request.query_params.get("success") if request and request.query_params else None %}
    {% set qs_error = request.query_params.get("error") if request and request.query_params else None %}

    {% if qs_success %}
    <div class="rounded-2xl border border-emerald-500/25 bg-emerald-500/10 px-4 py-3">
        <p class="text-[12px] text-emerald-200 font-medium">{{ qs_success }}</p>
    </div>
    {% endif %}

    {% if qs_error %}
    <div class="rounded-2xl border border-rose-500/25 bg-rose-500/10 px-4 py-3">
        <p class="text-[12px] text-rose-200 font-medium">{{ qs_error }}</p>
    </div>
    {% endif %}

    <!-- Nuevo pallet -->
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-4 sm:py-5">
        <div class="flex items-start justify-between gap-3">
            <div>
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wide">Nuevo pallet</p>
                <p class="text-[11px] text-slate-500">Crea un pallet operativo para comenzar a asignar líneas.</p>
            </div>
        </div>

        <form method="post" action="/inbound/recepciones/{{ recepcion.id }}/pallets/nuevo" class="mt-3 space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-12 gap-2">
                <div class="sm:col-span-4">
                    <input name="codigo_pallet"
                           placeholder="Código (ej: P001)"
                           class="w-full rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-[12px] text-slate-100 placeholder:text-slate-600
                        focus:outline-none focus:ring-2 focus:ring-cyan-500/40 focus:border-cyan-400"
                           required />
                </div>

                <div class="sm:col-span-2">
                    <input name="peso_bruto_kg"
                           placeholder="Bruto kg"
                           inputmode="decimal"
                           class="w-full rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-[12px] text-slate-100 placeholder:text-slate-600
                        focus:outline-none focus:ring-2 focus:ring-cyan-500/40 focus:border-cyan-400" />
                </div>

                <div class="sm:col-span-2">
                    <input name="peso_tara_kg"
                           placeholder="Tara kg"
                           inputmode="decimal"
                           class="w-full rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-[12px] text-slate-100 placeholder:text-slate-600
                        focus:outline-none focus:ring-2 focus:ring-cyan-500/40 focus:border-cyan-400" />
                </div>

                <div class="sm:col-span-2">
                    <input name="temperatura_promedio"
                           placeholder="Temp °C"
                           inputmode="decimal"
                           class="w-full rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-[12px] text-slate-100 placeholder:text-slate-600
                        focus:outline-none focus:ring-2 focus:ring-cyan-500/40 focus:border-cyan-400" />
                </div>

                <div class="sm:col-span-2">
                    <button type="submit"
                            class="w-full inline-flex items-center justify-center rounded-xl px-4 py-2 text-[12px] font-semibold
                         text-slate-900 bg-[#00E4FF] hover:bg-cyan-300 active:scale-[0.99] transition-transform transition-colors">
                        Crear
                    </button>
                </div>
            </div>

            <div>
                <textarea name="observaciones"
                          rows="2"
                          placeholder="Observaciones (recomendado, será obligatorio para cerrar)"
                          class="w-full rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-[12px] text-slate-100 placeholder:text-slate-600
                         focus:outline-none focus:ring-2 focus:ring-cyan-500/40 focus:border-cyan-400"></textarea>
            </div>

            <p class="text-[10px] text-slate-500">
                Tip enterprise: si ingresas bruto/tara, el neto se valida (tara no puede superar bruto).
            </p>
        </form>
    </section>

    <!-- Lista -->
    <section class="space-y-3">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-[11px] font-semibold text-slate-400 uppercase tracking-wide">Pallets</p>
            </div>
            <p class="text-[11px] text-slate-500">
                {{ pallets|length }} en esta recepción.
            </p>
        </div>

        {% if pallets and pallets|length > 0 %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            {% for p in pallets %}
            {% set r = resumen.get(p.id) if resumen else None %}
            {% set n_items = (r.get("n_items") if r else 0) %}
            {% set cant_real = (r.get("cant") if r else 0) %}
            {% set kg_real = (r.get("kg") if r else 0) %}
            {% set estado_txt = (p.estado.value if p.estado is not none and p.estado.value is defined else (p.estado|string)) %}
            {% set estado_txt = estado_txt.replace("PalletEstado.", "") %}


            <a href="/inbound/recepciones/{{ recepcion.id }}/pallets/{{ p.id }}"
               class="group rounded-2xl border border-slate-800 bg-slate-900/60 p-4 hover:border-cyan-500/40 transition-colors">
                <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                        <p class="text-sm font-semibold text-slate-100 truncate">{{ p.codigo_pallet }}</p>
                        <p class="text-[11px] text-slate-500 mt-0.5">
                            Estado: <span class="text-slate-300 font-medium">{{ estado_txt }}</span>
                        </p>
                    </div>

                    <span class="shrink-0 inline-flex items-center rounded-full border border-slate-700 px-3 py-1 text-[11px] font-semibold text-slate-200">
                        {{ estado_txt }}
                    </span>
                </div>

                <div class="mt-3 grid grid-cols-2 gap-2">
                    <div class="rounded-xl border border-slate-800 bg-slate-950/30 px-3 py-3">
                        <p class="text-[10px] text-slate-500 uppercase tracking-wide">Ítems</p>
                        <p class="text-sm font-semibold text-slate-100 mt-0.5">{{ n_items }}</p>
                    </div>

                    <div class="rounded-xl border border-slate-800 bg-slate-950/30 px-3 py-3">
                        <p class="text-[10px] text-slate-500 uppercase tracking-wide">Kg reales</p>
                        <p class="text-sm font-semibold text-slate-100 mt-0.5">
                            {% if kg_real and kg_real > 0 %}
                            {{ '%.3f'|format(kg_real) }}
                            {% else %}
                            0.000
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div class="mt-2 flex items-center justify-between">
                    <p class="text-[11px] text-slate-500">
                        {% if cant_real and cant_real > 0 %}
                        Real: <span class="text-slate-200 font-semibold">{{ '%.3f'|format(cant_real) }}</span> u
                        <span class="text-slate-600">·</span>
                        {% endif %}
                        {% if kg_real and kg_real > 0 %}
                        <span class="text-slate-200 font-semibold">{{ '%.3f'|format(kg_real) }}</span> kg
                        {% else %}
                        <span class="text-slate-600">Sin kg aún</span>
                        {% endif %}
                    </p>

                    <span class="text-[11px] text-cyan-300 font-semibold opacity-0 group-hover:opacity-100 transition-opacity">
                        Abrir →
                    </span>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 px-4 py-4">
            <p class="text-[12px] text-slate-300">Aún no hay pallets creados en esta recepción.</p>
        </div>
        {% endif %}
    </section>

</div>
{% endblock %}
