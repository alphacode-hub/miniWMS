<!-- modules/inbound_orbion/templates/inbound_pallets.html -->
{% extends "base/base_app.html" %}

{% block title %}ORBION · Pallets · {{ recepcion.codigo if recepcion is defined else "Inbound" }}{% endblock %}

{# HEADER BAJO TOPBAR (SOLO DESKTOP/TABLET) #}
{% block page_header %}
<div class="hidden sm:flex items-center justify-between gap-4">
    <div class="space-y-1 min-w-0">
        <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
            Inbound · Pallets
        </p>
        <h1 class="text-sm sm:text-lg font-semibold text-slate-100 tracking-tight truncate">
            Pallets · {{ recepcion.codigo }} · {{ recepcion.proveedor or "Sin proveedor" }}
        </h1>
        <p class="text-xs text-slate-400 leading-snug max-w-2xl">
            Virtualiza tu descarga: crea pallets, asigna líneas y controla trazabilidad por unidad/peso.
        </p>
    </div>

    <div class="flex items-center gap-2">
        <a href="/inbound/recepciones/{{ recepcion.id }}"
           class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1.5
                  text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition-colors">
            ← Volver al detalle
        </a>

        <a href="/inbound"
           class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1.5
                  text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition-colors">
            Inbound
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6 sm:space-y-8 max-w-5xl mx-auto">

    {# =========================
    ALERTAS / MENSAJES (baseline)
    ========================= #}
    {% set qs_error = request.query_params.get("error") if request is defined else None %}
    {% if qs_error %}
    <div class="rounded-2xl border border-rose-500/30 bg-rose-500/10 px-3 py-3 sm:px-4">
        <p class="text-[11px] text-rose-100 font-semibold">No se pudo completar la acción</p>
        <p class="text-[11px] text-rose-200/90 mt-1">{{ qs_error }}</p>
    </div>
    {% endif %}

    {% if flash is defined and flash %}
    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-3 sm:px-4">
        <p class="text-[11px] text-slate-200">{{ flash }}</p>
    </div>
    {% endif %}

    {# HEADER MOBILE #}
    <div class="sm:hidden space-y-3">
        <div class="space-y-1">
            <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                Inbound · Pallets
            </p>
            <h1 class="text-base font-semibold text-slate-100 tracking-tight">
                Pallets · {{ recepcion.codigo }}
            </h1>
            <p class="text-[11px] text-slate-400 leading-snug max-w-xs">
                Crea y gestiona pallets para controlar tu operación.
            </p>
            <p class="text-[11px] text-slate-500">
                {{ recepcion.proveedor or "Sin proveedor" }}
            </p>
        </div>

        <div class="flex flex-wrap gap-2">
            <a href="/inbound/recepciones/{{ recepcion.id }}"
               class="inline-flex flex-1 items-center justify-center rounded-full border border-slate-700 px-3 py-1.5
                      text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                ← Detalle
            </a>
            <a href="/inbound"
               class="inline-flex items-center justify-center rounded-full border border-slate-700 px-3 py-1.5
                      text-[11px] font-medium text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                Inbound
            </a>
        </div>
    </div>

    {# =========================
    RESUMEN / KPI (enterprise)
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-4 sm:py-5">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
            <div class="space-y-1">
                <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                    Recepción
                </p>
                <p class="text-xs sm:text-sm text-slate-100 font-semibold">
                    {{ recepcion.codigo }} · {{ recepcion.proveedor or "Sin proveedor" }}
                </p>

                <div class="flex flex-wrap items-center gap-2 pt-1">
                    <span class="inline-flex items-center rounded-full border border-slate-700 px-2.5 py-0.5
                                 text-[10px] font-semibold text-slate-200 bg-slate-950/30">
                        {{ recepcion.estado.replace('_', ' ') }}
                    </span>

                    <span class="text-[11px] text-slate-400">
                        Creado:
                        {% if recepcion.creado_en %}
                        <span class="text-slate-200">{{ recepcion.creado_en.strftime('%d-%m-%Y %H:%M') }}</span>
                        {% else %}
                        <span class="text-slate-500">—</span>
                        {% endif %}
                    </span>
                </div>

                <p class="text-[11px] text-slate-500 leading-snug pt-2 max-w-2xl">
                    Tip: Crea pallets “por cámara / por producto / por zona” para que el conteo sea más rápido y la trazabilidad más limpia.
                </p>
            </div>

            {# Accesos rápidos (alineados al baseline de inbound_lista) #}
            <div class="flex flex-wrap gap-2 justify-start sm:justify-end">
                <a href="/inbound/recepciones/{{ recepcion.id }}/checklist"
                   class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1.5
                          text-[11px] font-medium text-slate-200 bg-slate-900
                          hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                    Checklist
                </a>
                <a href="/inbound/recepciones/{{ recepcion.id }}/documentos"
                   class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1.5
                          text-[11px] font-medium text-slate-200 bg-slate-900
                          hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                    Documentos
                </a>
                <a href="/inbound/recepciones/{{ recepcion.id }}/fotos"
                   class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1.5
                          text-[11px] font-medium text-slate-200 bg-slate-900
                          hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                    Fotos
                </a>
            </div>
        </div>

        {# KPIs #}
        {% set total_pallets = kpi_total_pallets if kpi_total_pallets is defined else ((pallets|length) if pallets is defined else 0) %}
        {% set con_lineas = kpi_con_lineas if kpi_con_lineas is defined else 0 %}
        {% set en_proceso = kpi_en_proceso if kpi_en_proceso is defined else 0 %}
        {% set listos = kpi_listos if kpi_listos is defined else 0 %}

        <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="rounded-2xl border border-slate-800 bg-slate-950/40 px-3 py-3">
                <p class="text-[10px] text-slate-400 uppercase font-semibold tracking-wide">Pallets</p>
                <p class="text-lg font-semibold text-slate-100">{{ total_pallets }}</p>
                <p class="text-[10px] text-slate-500 mt-1">Total creados</p>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-950/40 px-3 py-3">
                <p class="text-[10px] text-slate-400 uppercase font-semibold tracking-wide">Con líneas</p>
                <p class="text-lg font-semibold text-slate-100">{{ con_lineas }}</p>
                <p class="text-[10px] text-slate-500 mt-1">Pallets con asignación</p>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-950/40 px-3 py-3">
                <p class="text-[10px] text-slate-400 uppercase font-semibold tracking-wide">En proceso</p>
                <p class="text-lg font-semibold text-slate-100">{{ en_proceso }}</p>
                <p class="text-[10px] text-slate-500 mt-1">ABIERTO / EN PROCESO</p>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-950/40 px-3 py-3">
                <p class="text-[10px] text-slate-400 uppercase font-semibold tracking-wide">Listos</p>
                <p class="text-lg font-semibold text-slate-100">{{ listos }}</p>
                <p class="text-[10px] text-slate-500 mt-1">Marcados como LISTO</p>
            </div>
        </div>
    </section>

    {# =========================
    CREAR PALLET
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-4 sm:py-5 space-y-3">
        <header class="space-y-1">
            <div class="flex items-center justify-between gap-3">
                <div>
                    <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">Crear pallet</p>
                    <p class="text-[11px] text-slate-400 max-w-2xl">
                        Crea un pallet virtual para agrupar líneas y luego adjuntar checklist, docs y fotos.
                    </p>
                </div>
                <span class="hidden sm:inline-flex items-center rounded-full border border-slate-800 px-3 py-1.5
                             text-[11px] font-medium text-slate-400 bg-slate-950/20">
                    Recomendado: PAL-001, PAL-002…
                </span>
            </div>
        </header>

        <form method="post"
              action="/inbound/recepciones/{{ recepcion.id }}/pallets/nuevo"
              class="grid grid-cols-1 sm:grid-cols-12 gap-3 pt-2 border-t border-slate-800/80">

            <div class="sm:col-span-4 space-y-1">
                <label class="text-[11px] font-semibold text-slate-200">
                    Código pallet <span class="text-rose-400">*</span>
                </label>
                <input type="text" name="codigo_pallet"
                       required
                       placeholder="PAL-001"
                       autocomplete="off"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2
                              text-xs sm:text-sm text-slate-100 placeholder-slate-500
                              focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                <p class="text-[10px] text-slate-500">Se normaliza a MAYÚSCULAS en backend.</p>
            </div>

            <div class="sm:col-span-2 space-y-1">
                <label class="text-[11px] font-semibold text-slate-200">Bruto (kg)</label>
                <input type="number" step="0.01" name="peso_bruto_kg" inputmode="decimal"
                       placeholder="0"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2
                              text-xs sm:text-sm text-slate-100 placeholder-slate-500
                              focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
            </div>

            <div class="sm:col-span-2 space-y-1">
                <label class="text-[11px] font-semibold text-slate-200">Tara (kg)</label>
                <input type="number" step="0.01" name="peso_tara_kg" inputmode="decimal"
                       placeholder="0"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2
                              text-xs sm:text-sm text-slate-100 placeholder-slate-500
                              focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
            </div>

            <div class="sm:col-span-2 space-y-1">
                <label class="text-[11px] font-semibold text-slate-200">Bultos</label>
                <input type="number" step="1" name="bultos" inputmode="numeric"
                       placeholder="0"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2
                              text-xs sm:text-sm text-slate-100 placeholder-slate-500
                              focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
            </div>

            <div class="sm:col-span-2 space-y-1">
                <label class="text-[11px] font-semibold text-slate-200">Temp (°C)</label>
                <input type="number" step="0.1" name="temperatura_promedio" inputmode="decimal"
                       placeholder="0"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2
                              text-xs sm:text-sm text-slate-100 placeholder-slate-500
                              focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
            </div>

            <div class="sm:col-span-10 space-y-1">
                <label class="text-[11px] font-semibold text-slate-200">Observaciones</label>
                <input type="text" name="observaciones"
                       placeholder="Notas del pallet (daños, temperatura, etc.)"
                       class="w-full rounded-xl border border-slate-700 bg-slate-900 px-3 py-2
                              text-xs sm:text-sm text-slate-100 placeholder-slate-500
                              focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
            </div>

            <div class="sm:col-span-2 flex items-end">
                <button type="submit"
                        class="w-full inline-flex items-center justify-center rounded-full px-4 py-2
                               text-[11px] font-semibold text-slate-900 bg-[#00E4FF]
                               hover:bg-cyan-300 active:scale-[0.98]
                               transition-transform transition-colors">
                    + Crear
                </button>
            </div>
        </form>
    </section>

    {# =========================
    LISTA DE PALLETS
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-4 sm:py-5 space-y-4">
        <header class="flex items-center justify-between gap-3">
            <div class="space-y-0.5">
                <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">
                    Pallets
                </p>
                <p class="text-[11px] text-slate-400">
                    Haz click en un pallet para ver su detalle.
                </p>
            </div>

            {% if pallets is defined %}
            <div class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1 text-[11px] text-slate-300">
                <span class="mr-1 text-slate-500">Total:</span>
                <span class="font-semibold text-slate-100">{{ pallets|length }}</span>
            </div>
            {% endif %}
        </header>

        {% if pallets is defined and pallets %}
        <div class="space-y-3">
            {% for p in pallets %}
            {% set nlineas = (lineas_por_pallet.get(p.id, 0) if lineas_por_pallet is defined else 0) %}
            {% set cant_total = (cant_por_pallet.get(p.id, 0) if cant_por_pallet is defined else 0) %}
            {% set kg_total = (kg_por_pallet.get(p.id, 0) if kg_por_pallet is defined else 0) %}
            {% set est = (p.estado or 'ABIERTO')|upper %}

            <div class="rounded-2xl border border-slate-800 bg-slate-900 px-3 py-3
                        hover:border-cyan-400/60 hover:bg-slate-900/80 transition-colors"
                 role="button" tabindex="0"
                 onclick="window.location.href='/inbound/recepciones/{{ recepcion.id }}/pallets/{{ p.id }}'"
                 onkeydown="if(event.key==='Enter'){window.location.href='/inbound/recepciones/{{ recepcion.id }}/pallets/{{ p.id }}'}">

                <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0 space-y-1">
                        <div class="flex items-center gap-2">
                            <p class="text-xs sm:text-sm font-semibold text-slate-100 truncate">
                                {{ p.codigo_pallet or ('PAL-' ~ p.id) }}
                            </p>

                            {# Estado visual: vacío vs con líneas (operativo) #}
                            {% if nlineas > 0 %}
                            <span class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border
                                         bg-cyan-500/15 text-cyan-200 border-cyan-500/30">
                                CON LÍNEAS
                            </span>
                            {% else %}
                            <span class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border
                                         bg-slate-700/30 text-slate-200 border-slate-600">
                                VACÍO
                            </span>
                            {% endif %}
                        </div>

                        {% if p.observaciones %}
                        <p class="text-[11px] text-slate-400 truncate">
                            {{ p.observaciones }}
                        </p>
                        {% else %}
                        <p class="text-[11px] text-slate-500 truncate">
                            Sin observaciones
                        </p>
                        {% endif %}

                        {# Mini métricas por pallet #}
                        <div class="mt-2 flex flex-wrap gap-2">
                            <span class="inline-flex items-center rounded-full border border-slate-800 px-3 py-1
                                         text-[10px] font-semibold text-slate-200 bg-slate-950/20">
                                Líneas: <span class="ml-1 text-slate-100">{{ nlineas }}</span>
                            </span>

                            <span class="inline-flex items-center rounded-full border border-slate-800 px-3 py-1
                                         text-[10px] font-semibold text-slate-200 bg-slate-950/20">
                                Cantidad: <span class="ml-1 text-slate-100">{{ '%.3f'|format(cant_total) }}</span>
                            </span>

                            <span class="inline-flex items-center rounded-full border border-slate-800 px-3 py-1
                                         text-[10px] font-semibold text-slate-200 bg-slate-950/20">
                                Kg: <span class="ml-1 text-slate-100">{{ '%.3f'|format(kg_total) }}</span>
                            </span>
                        </div>

                        <div class="mt-2 flex flex-wrap gap-2">
                            <a href="/inbound/recepciones/{{ recepcion.id }}/pallets/{{ p.id }}"
                               onclick="event.stopPropagation();"
                               class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1
                                      text-[10px] font-semibold text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition-colors">
                                Ver detalle
                            </a>

                            <span class="inline-flex items-center rounded-full border border-slate-800 px-3 py-1
                                         text-[10px] font-semibold text-slate-500 bg-slate-900/60 cursor-not-allowed"
                                  title="Pendiente de implementar ruta">
                                Etiqueta
                            </span>

                            <form method="post"
                                  action="/inbound/recepciones/{{ recepcion.id }}/pallets/{{ p.id }}/eliminar"
                                  onsubmit="event.stopPropagation(); return confirm('¿Eliminar este pallet?');">
                                <button type="submit"
                                        class="inline-flex items-center rounded-full border border-rose-500/40 px-3 py-1
                                               text-[10px] font-semibold text-rose-200 hover:border-rose-400 hover:text-rose-100 transition-colors">
                                    Eliminar
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="flex flex-col items-end gap-1 shrink-0">
                        {# Estado del pallet (enterprise real) #}
                        <span class="inline-flex items-center rounded-full px-2 py-[2px] text-[10px] font-semibold border
                            {% if est == 'LISTO' %}
                                bg-emerald-500/10 text-emerald-200 border-emerald-500/40
                            {% elif est == 'EN_PROCESO' %}
                                bg-indigo-500/10 text-indigo-200 border-indigo-500/40
                            {% else %}
                                bg-slate-700/40 text-slate-100 border-slate-600
                            {% endif %}">
                            {{ est.replace('_', ' ') }}
                        </span>

                        <p class="text-[10px] text-slate-400 whitespace-nowrap">
                            {% if p.creado_en %}
                            {{ p.creado_en.strftime('%d-%m-%Y %H:%M') }}
                            {% else %}
                            —{% endif %}
                        </p>

                        {# Peso neto si existe #}
                        <p class="text-[10px] text-slate-500 whitespace-nowrap">
                            Neto:
                            <span class="text-slate-200 font-semibold">
                                {% if p.peso_neto_kg is not none %}
                                {{ '%.3f'|format(p.peso_neto_kg) }} kg
                                {% else %}
                                —{% endif %}
                            </span>
                        </p>
                    </div>
                </div>

                {# Barra visual (enterprise mínimo): estado manda; si ABIERTO, estimación por líneas #}
                <div class="mt-3">
                    {% set pct = 0 %}
                    {% if est == 'LISTO' %}
                    {% set pct = 100 %}
                    {% elif est == 'EN_PROCESO' %}
                    {% set pct = 66 %}
                    {% else %}
                    {% if nlineas >= 8 %}{% set pct = 100 %}
                    {% elif nlineas >= 5 %}{% set pct = 66 %}
                    {% elif nlineas >= 2 %}{% set pct = 33 %}
                    {% elif nlineas == 1 %}{% set pct = 18 %}
                    {% else %}{% set pct = 0 %}
                    {% endif %}
                    {% endif %}

                    <div class="h-2 w-full rounded-full bg-slate-950/50 border border-slate-800 overflow-hidden">
                        <div class="h-full bg-[#00E4FF]" style="width: {{ pct }}%;"></div>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-1">
                        Progreso: usa estado del pallet (LISTO/EN PROCESO) y, si está ABIERTO, se estima por líneas.
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <div class="rounded-xl border border-dashed border-slate-700 bg-slate-900 px-4 py-6 text-center space-y-1.5">
            <p class="text-xs font-semibold text-slate-100">
                Aún no hay pallets creados.
            </p>
            <p class="text-[11px] text-slate-400 max-w-sm mx-auto">
                Crea tu primer pallet para comenzar a virtualizar líneas y evidencias operativas.
            </p>
        </div>
        {% endif %}
    </section>

    {# =========================
    PRÓXIMAS SECCIONES (UI READY)
    ========================= #}
    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-4 sm:px-4 sm:py-5 space-y-3">
        <p class="text-[11px] font-semibold tracking-wide text-slate-400 uppercase">Siguiente nivel</p>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
            <span class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-3 text-[11px] text-slate-400">
                Estados reales ✅
            </span>
            <span class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-3 text-[11px] text-slate-400">
                Checklist por pallet (pendiente)
            </span>
            <span class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-3 text-[11px] text-slate-400">
                Evidencias (docs/fotos) (pendiente)
            </span>
            <span class="rounded-2xl border border-slate-800 bg-slate-900/60 px-3 py-3 text-[11px] text-slate-400">
                Etiqueta QR (pendiente)
            </span>
        </div>
        <p class="text-[10px] text-slate-500">
            Lo siguiente: checklist + evidencias por pallet y luego QR/etiqueta para trazabilidad en piso.
        </p>
    </section>

</div>
{% endblock %}
