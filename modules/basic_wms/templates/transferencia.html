{% extends "base.html" %}
{% block title %}Transferencia - Mini WMS{% endblock %}

{% block content %}
<div class="w-full max-w-4xl mx-auto px-4 py-4 sm:py-6">
    <section class="bg-white shadow-sm rounded-2xl border border-slate-100
                     px-4 py-4 sm:px-6 sm:py-5 space-y-4">

        <!-- HEADER -->
        <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
                <h1 class="text-lg sm:text-xl font-semibold text-slate-900">
                    Transferencia entre slots
                </h1>
                <p class="text-xs sm:text-sm text-slate-500 mt-1">
                    Mueve stock del slot origen al slot destino dentro de
                    <span class="font-semibold">{{ user.negocio }}</span>,
                    sin modificar el stock total del producto.
                </p>
            </div>

            <!-- Volver desktop -->
            <a href="/stock"
               class="hidden sm:inline-flex items-center text-[11px] text-slate-500 hover:text-slate-700 hover:underline">
                ← Volver a stock
            </a>
        </header>

        <!-- ERROR -->
        {% if error %}
        <div class="bg-rose-50 border border-rose-200 text-rose-700 text-xs rounded-xl px-3 py-2">
            {{ error }}
        </div>
        {% endif %}

        <!-- FORMULARIO -->
        <form method="post" class="space-y-4">

            <!-- Producto + cantidad -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

                <!-- Producto -->
                <div class="space-y-1">
                    <label for="producto" class="block text-xs font-medium text-slate-700">
                        Producto
                    </label>
                    <!-- Código SKU/EAN (opcional, para sincronizar producto) -->
                    <div class="mt-2 space-y-1">
                        <label for="codigo" class="block text-[10px] font-medium text-slate-600">
                            Código de producto (SKU / EAN) <span class="font-normal text-slate-400">(opcional)</span>
                        </label>
                        <input id="codigo"
                               name="codigo"
                               type="text"
                               inputmode="numeric"
                               autocomplete="off"
                               value="{{ codigo or '' }}"
                               class="w-full rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-sm text-slate-900
                  focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Escribe o escanea el código en otra pantalla" />
                        <p class="text-[10px] text-slate-400">
                            Si ingresas un SKU o EAN que coincida con un producto, se seleccionará automáticamente en la lista.
                        </p>
                    </div>
                    <select id="producto"
                            name="producto"
                            required
                            class="w-full rounded-xl bg-white border border-slate-200 px-3 py-2 text-sm text-slate-900
                                   focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Selecciona producto</option>
                        {% for p in productos %}
                        <option value="{{ p.nombre }}"
                                data-sku="{{ p.sku or '' }}"
                                data-ean="{{ p.ean13 or '' }}"
                                {% if producto is defined and producto == p.nombre %}selected{% endif %}>
                            {{ p.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-[10px] text-slate-400">
                        Sólo se permitirá transferir si hay stock suficiente en el slot origen.
                    </p>


                </div>

                <!-- Cantidad -->
                <div class="space-y-1">
                    <label for="cantidad" class="block text-xs font-medium text-slate-700">
                        Cantidad a transferir
                    </label>
                    <input id="cantidad"
                           type="number"
                           name="cantidad"
                           min="1"
                           value="{{ cantidad or '' }}"
                           required
                           class="w-full rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Ej: 10" />
                    <p class="mt-1 text-[10px] text-slate-400">
                        Esta cantidad se restará del slot origen y se sumará al slot destino.
                    </p>
                </div>
            </div>

            <!-- Slots -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Slot origen -->
                <div class="space-y-1">
                    <label for="slot_origen_id" class="block text-xs font-medium text-slate-700">
                        Desde slot (origen)
                    </label>
                    <select id="slot_origen_id"
                            name="slot_origen_id"
                            required
                            class="w-full rounded-xl bg-white border border-slate-200 px-3 py-2 text-sm text-slate-900
                                   focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Selecciona slot origen</option>
                        {% for s in slots %}
                        <option value="{{ s.id }}"
                                {% if slot_origen_id and slot_origen_id|int == s.id %}selected{% endif %}>
                            {{ s.ubicacion.zona.nombre if s.ubicacion and s.ubicacion.zona else "-" }}
                            /
                            {{ s.ubicacion.nombre if s.ubicacion else "-" }}
                            /
                            {{ s.codigo }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-[10px] text-slate-400">
                        Slot desde donde saldrá el stock.
                    </p>
                </div>

                <!-- Slot destino -->
                <div class="space-y-1">
                    <label for="slot_destino_id" class="block text-xs font-medium text-slate-700">
                        Hacia slot (destino)
                    </label>
                    <select id="slot_destino_id"
                            name="slot_destino_id"
                            required
                            class="w-full rounded-xl bg-white border border-slate-200 px-3 py-2 text-sm text-slate-900
                                   focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Selecciona slot destino</option>
                        {% for s in slots %}
                        <option value="{{ s.id }}"
                                {% if slot_destino_id and slot_destino_id|int == s.id %}selected{% endif %}>
                            {{ s.ubicacion.zona.nombre if s.ubicacion and s.ubicacion.zona else "-" }}
                            /
                            {{ s.ubicacion.nombre if s.ubicacion else "-" }}
                            /
                            {{ s.codigo }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-[10px] text-slate-400">
                        Slot donde quedará físicamente el stock después de la transferencia.
                    </p>
                </div>
            </div>

            <!-- BOTONES -->
            <div class="flex flex-col sm:flex-row sm:justify-end gap-2 pt-1">
                <a href="/stock"
                   class="w-full sm:w-auto inline-flex items-center justify-center rounded-xl px-3 py-2 text-[11px] font-semibold
                          border border-slate-200 text-slate-700 bg-white hover:bg-slate-50">
                    Cancelar
                </a>
                <button type="submit"
                        class="w-full sm:w-auto inline-flex items-center justify-center rounded-xl px-3 py-2 text-[11px] font-semibold
                               bg-slate-900 hover:bg-slate-800 text-white shadow-sm active:scale-[0.98] transition">
                    Registrar transferencia
                </button>
            </div>
        </form>

        <!-- PIE -->
        <div class="pt-3 border-t border-slate-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
            <p class="text-[11px] text-slate-500">
                Siguiente paso recomendado:
                <span class="font-semibold text-slate-800">
                    revisar el stock consolidado
                </span>
                en la vista de stock para confirmar la transferencia.
            </p>

            <!-- Volver móvil -->
            <a href="/stock"
               class="block text-center text-[11px] text-slate-500 hover:text-slate-700 sm:hidden">
                ← Volver al stock
            </a>
        </div>

    </section>
</div>

<!-- SCRIPT: sincronizar producto desde código (SKU / EAN) -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const codigoInput = document.getElementById("codigo");
        const selectProducto = document.getElementById("producto");

        if (!codigoInput || !selectProducto) return;

        // Mapa código -> nombre de producto
        const codeToValue = new Map();

        Array.from(selectProducto.options).forEach(opt => {
            const value = opt.value;
            if (!value) return;  // saltar placeholder

            const sku = (opt.dataset.sku || "").trim();
            const ean = (opt.dataset.ean || "").trim();

            if (sku) codeToValue.set(sku, value);
            if (ean) codeToValue.set(ean, value);
        });

        function syncSelectFromCodigoTransfer() {
            const code = (codigoInput.value || "").trim();
            if (!code) return;

            const value = codeToValue.get(code);
            if (value) {
                selectProducto.value = value;

                // pequeño feedback visual
                selectProducto.classList.add("ring-2", "ring-emerald-400");
                setTimeout(() => {
                    selectProducto.classList.remove("ring-2", "ring-emerald-400");
                }, 400);
            }
        }

        // Sincronizar en eventos típicos de input
        codigoInput.addEventListener("change", syncSelectFromCodigoTransfer);
        codigoInput.addEventListener("blur", syncSelectFromCodigoTransfer);
        codigoInput.addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
                syncSelectFromCodigoTransfer();
            }
        });

        // Lo dejamos en window por si más adelante quisieras llamarlo desde otro script
        window.syncProductoDesdeCodigoTransfer = syncSelectFromCodigoTransfer;
    });
</script>
{% endblock %}
