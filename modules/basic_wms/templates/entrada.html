{% extends "base.html" %}
{% block title %}Registrar entrada - Mini WMS{% endblock %}

{% block content %}
<div class="w-full max-w-4xl mx-auto px-4 py-4 sm:py-6">
    <section class="bg-white shadow-sm rounded-2xl border border-slate-100
                     px-4 py-4 sm:px-6 sm:py-5 space-y-4">

        <!-- HEADER -->
        <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
                <h1 class="text-lg sm:text-xl font-semibold text-slate-900">
                    Registrar entrada
                </h1>
                <p class="text-xs sm:text-sm text-slate-500 mt-1">
                    Registra entradas de mercadería en los slots que ya definiste.
                    El stock se actualizará automáticamente en el inventario de
                    <span class="font-semibold">{{ user.negocio }}</span>.
                </p>
            </div>

            <!-- Volver desktop -->
            <a href="/movimientos"
               class="hidden sm:inline-flex items-center text-[11px] text-slate-500 hover:text-slate-700 hover:underline">
                ← Volver a movimientos
            </a>
        </header>

        <!-- ERROR -->
        {% if error %}
        <div class="bg-rose-50 border border-rose-200 text-rose-700 text-xs rounded-xl px-3 py-2">
            {{ error }}
        </div>
        {% endif %}

        <!-- FORMULARIO -->
        <form method="post"
              action="/movimientos/entrada"
              class="space-y-4">

            <!-- Producto -->
            <div class="space-y-1">
                <label for="producto" class="block text-xs font-medium text-slate-700">
                    Producto
                </label>
                <select id="producto"
                        name="producto"
                        required
                        class="w-full rounded-xl bg-white border border-slate-200 px-3 py-2 text-sm text-slate-900
                               focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecciona un producto</option>
                    {% for p in productos %}
                    <option value="{{ p.nombre }}"
                            data-sku="{{ p.sku or '' }}"
                            data-ean="{{ p.ean13 or '' }}"
                            {% if producto is defined and producto == p.nombre %}selected{% endif %}>
                        {{ p.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Código SKU / EAN + botón cámara (input SIEMPRE visible) -->
            <div class="space-y-1">
                <label for="codigo" class="block text-xs font-medium text-slate-700">
                    Código de producto (SKU / EAN)
                </label>

                <div class="flex items-center gap-2">
                    <!-- Input visible en desktop, móvil y tablet -->
                    <input id="codigo"
                           name="codigo"
                           type="text"
                           inputmode="numeric"
                           autocomplete="off"
                           value="{{ codigo or '' }}"
                           class="flex-1 rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-sm text-slate-900
                                  focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Escanea o escribe el código" />

                    <!-- Botón de cámara: se oculta en desktop vía JS -->
                    <button type="button"
                            id="btn-scan"
                            class="inline-flex items-center justify-center rounded-xl px-2.5 py-2
                                   text-[11px] font-semibold bg-slate-900 text-white
                                   hover:bg-slate-800 active:scale-[0.97] transition">
                        📷
                    </button>
                </div>

                <p class="text-[10px] text-slate-400">
                    En computador escribe el código manualmente. En móvil y tablet puedes usar la cámara para escanear.
                </p>
            </div>

            <!-- Contenedor del lector (sólo se muestra cuando se escanea en móvil/tablet) -->
            <div id="scan-section" class="mt-4 hidden">
                <!-- Overlay pantalla completa -->
                <div id="scan-overlay" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-40"></div>

                <div class="relative z-50 rounded-2xl border border-slate-200 bg-slate-50 p-3 space-y-2">
                    <p class="text-[11px] text-slate-600">
                        Apunta la cámara al código de barras o QR del producto.
                    </p>

                    <!-- Visor grande -->
                    <div id="reader"
                         class="w-full h-[70vh] sm:h-80 rounded-2xl overflow-hidden bg-black/90 flex items-center justify-center">
                    </div>

                    <button type="button"
                            id="btn-stop-scan"
                            class="mt-2 inline-flex items-center justify-center rounded-xl px-3 py-1.5 text-[11px] font-semibold
                                   border border-slate-300 text-slate-700 bg-white hover:bg-slate-50">
                        Detener cámara
                    </button>
                </div>
            </div>

            <!-- Cantidad -->
            <div class="space-y-1">
                <label for="cantidad" class="block text-xs font-medium text-slate-700">
                    Cantidad
                </label>
                <input id="cantidad"
                       type="number"
                       name="cantidad"
                       min="1"
                       required
                       value="{{ cantidad or '' }}"
                       class="w-full rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-sm text-slate-900
                              focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                       placeholder="1" />
                <p class="text-[10px] text-slate-400">
                    Ingresa la cantidad total que estás recibiendo en este movimiento.
                </p>
            </div>

            <!-- Ubicación / Slot -->
            <div class="space-y-1">
                <label for="slot_id" class="block text-xs font-medium text-slate-700">
                    Ubicación (zona / ubicación / slot)
                </label>
                <select id="slot_id"
                        name="slot_id"
                        required
                        class="w-full rounded-xl bg-white border border-slate-200 px-3 py-2 text-sm text-slate-900
                               focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecciona zona / ubicación / slot</option>
                    {% for s in slots %}
                    <option value="{{ s.id }}"
                            {% if slot_id is defined and slot_id == s.id %}selected{% endif %}>
                        {{ s.codigo_full }}
                    </option>
                    {% endfor %}
                </select>
                <p class="text-[10px] text-slate-400">
                    Para un control más ordenado, intenta usar siempre el mismo slot para el mismo tipo de producto.
                </p>
            </div>

            <!-- Fecha de vencimiento -->
            <div class="space-y-1">
                <label for="fecha_vencimiento" class="block text-xs font-medium text-slate-700">
                    Fecha de vencimiento <span class="font-normal text-slate-400">(opcional)</span>
                </label>
                <input id="fecha_vencimiento"
                       type="date"
                       name="fecha_vencimiento"
                       value="{% if fecha_vencimiento is defined %}{{ fecha_vencimiento }}{% endif %}"
                       class="w-full rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-sm text-slate-900
                              focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
                              appearance-none" />
                <p class="text-[10px] text-slate-400">
                    Si la dejas vacía, el lote ingresará sin fecha de vencimiento.
                </p>
            </div>

            <!-- Fecha de entrada -->
            <div class="space-y-1">
                <label for="fecha" class="block text-xs font-medium text-slate-700">
                    Fecha de entrada
                </label>
                <input id="fecha"
                       type="date"
                       name="fecha"
                       value="{{ fecha or '' }}"
                       class="w-full rounded-xl bg-slate-50 border border-slate-200 px-3 py-2 text-sm text-slate-900
                              focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500
                              appearance-none" />
                <p class="text-[10px] text-slate-400">
                    Si no eliges una fecha, se usará la fecha y hora actuales.
                </p>
            </div>

            <!-- BOTONES -->
            <div class="flex flex-col sm:flex-row sm:justify-end gap-2 pt-1">
                <a href="/movimientos"
                   class="w-full sm:w-auto inline-flex items-center justify-center px-3 py-2 rounded-xl text-[11px] font-semibold
                          border border-slate-200 text-slate-700 bg-white hover:bg-slate-50">
                    Cancelar
                </a>
                <button type="submit"
                        class="w-full sm:w-auto inline-flex items-center justify-center px-3 py-2 rounded-xl text-[11px] font-semibold
                               bg-slate-900 text-white hover:bg-slate-800 shadow-sm active:scale-[0.98] transition">
                    Registrar entrada
                </button>
            </div>
        </form>

        <!-- PIE -->
        <div class="pt-3 border-t border-slate-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
            <p class="text-[11px] text-slate-500">
                Siguiente paso recomendado:
                <span class="font-semibold text-slate-800">
                    revisar el stock actualizado
                </span>
                en la vista de <span class="font-semibold">Stock</span> o registrar nuevas entradas.
            </p>

            <!-- Volver móvil -->
            <a href="/movimientos"
               class="block text-center text-[11px] text-slate-500 hover:text-slate-700 sm:hidden">
                ← Volver a movimientos
            </a>
        </div>

    </section>
</div>

<!-- SCRIPT: sincronizar producto desde código + escáner en móviles -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const codigoInput = document.getElementById("codigo");
        const selectProducto = document.getElementById("producto");

        // Si falta algo crítico, no hacemos nada
        if (!codigoInput || !selectProducto) {
            return;
        }

        // ============================
        // 1) Mapa código -> nombre producto (SKU / EAN)
        // ============================
        const codeToValue = new Map();

        Array.from(selectProducto.options).forEach(opt => {
            const value = opt.value;
            if (!value) return; // saltar opción placeholder

            const sku = (opt.dataset.sku || "").trim();
            const ean = (opt.dataset.ean || "").trim();

            if (sku) codeToValue.set(sku, value);
            if (ean) codeToValue.set(ean, value);
        });

        function syncSelectFromCodigoEntrada() {
            const code = (codigoInput.value || "").trim();
            if (!code) return;

            const value = codeToValue.get(code);
            if (value) {
                selectProducto.value = value;

                // feedback visual pequeño
                selectProducto.classList.add("ring-2", "ring-emerald-400");
                setTimeout(() => {
                    selectProducto.classList.remove("ring-2", "ring-emerald-400");
                }, 400);
            }
        }

        // Exponer global para que el escáner pueda llamarlo
        window.syncProductoDesdeCodigoEntrada = syncSelectFromCodigoEntrada;

        // Sincronizar cuando se escribe o se confirma el código
        codigoInput.addEventListener("change", syncSelectFromCodigoEntrada);
        codigoInput.addEventListener("blur", syncSelectFromCodigoEntrada);
        codigoInput.addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
                syncSelectFromCodigoEntrada();
            }
        });

        // ============================
        // 2) Lógica de escáner (sólo móviles/tablets)
        // ============================
        const btnScan = document.getElementById("btn-scan");
        const btnStop = document.getElementById("btn-stop-scan");
        const scanSection = document.getElementById("scan-section");
        const overlay = document.getElementById("scan-overlay");

        // Si no hay botón o sección, no configuramos el escáner
        if (!btnScan || !scanSection) {
            return;
        }

        // Detectar dispositivo táctil (móvil / tablet)
        const isTouchDevice =
            ("ontouchstart" in window) ||
            (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) ||
            (navigator.msMaxTouchPoints && navigator.msMaxTouchPoints > 0);

        // En desktop: ocultamos botón de cámara y el visor
        if (!isTouchDevice) {
            btnScan.classList.add("hidden");
            scanSection.classList.add("hidden");
            if (overlay) overlay.classList.add("hidden");
            return;
        }

        let html5QrCode = null;
        let scanning = false;

        function stopScanner() {
            if (overlay) overlay.classList.add("hidden");

            if (!html5QrCode || !scanning) {
                scanSection.classList.add("hidden");
                return;
            }

            html5QrCode.stop().then(() => {
                scanning = false;
                scanSection.classList.add("hidden");
            }).catch(err => {
                console.error("Error al detener el escáner:", err);
                scanning = false;
                scanSection.classList.add("hidden");
            });
        }

        function startScanner() {
            if (scanning) return;

            // Validar que la librería esté disponible
            if (typeof Html5Qrcode === "undefined") {
                console.error("Html5Qrcode no está definido. Revisa el <script> en base.html");
                alert("No se pudo iniciar el lector de códigos. Verifica la configuración del escáner.");
                return;
            }

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }

            if (overlay) overlay.classList.remove("hidden");
            scanSection.classList.remove("hidden");
            scanning = true;

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    // Escribimos el código escaneado en el input
                    codigoInput.value = decodedText;

                    // Feedback de vibración en móviles
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }

                    // Sincronizar select de producto desde el código
                    if (window.syncProductoDesdeCodigoEntrada) {
                        window.syncProductoDesdeCodigoEntrada();
                    }

                    // Detener scanner y cerrar visor correctamente
                    stopScanner();
                },
                (errorMessage) => {
                    // Ignoramos errores de lectura continua
                }
            ).catch(err => {
                console.error("No se pudo iniciar la cámara:", err);
                alert("No se pudo acceder a la cámara. Revisa permisos del navegador.");
                scanning = false;
                stopScanner();
            });
        }

        btnScan.addEventListener("click", function (e) {
            e.preventDefault();
            startScanner();
        });

        if (btnStop) {
            btnStop.addEventListener("click", function (e) {
                e.preventDefault();
                stopScanner();
            });
        }
    });
</script>
{% endblock %}
